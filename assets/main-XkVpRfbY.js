const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/pidtverdutu_sberihannya_zakaz_naryad-CvddQjkZ.js","assets/supabaseClient-B7prqs4z.js","assets/supabase-DN1VNG-x.js","assets/supabaseClient-DuvXYOtG.css","assets/pdf-Ch-uhDT6.js"])))=>i.map(i=>d[i]);
var Jt=Object.defineProperty;var jt=(e,t,n)=>t in e?Jt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var Oe=(e,t,n)=>jt(e,typeof t!="symbol"?t+"":t,n);import{s as _}from"./supabaseClient-B7prqs4z.js";import{h as Zt,E as Kt}from"./pdf-Ch-uhDT6.js";import{_ as Qt}from"./supabase-DN1VNG-x.js";function E(e,t="info",n=3e3){const o={success:{bg:"#10b981",border:"#059669"},error:{bg:"#ef4444",border:"#dc2626"},warning:{bg:"#f59e0b",border:"#d97706"},info:{bg:"#3b82f6",border:"#2563eb"}},s={success:"✅",error:"❌",warning:"⚠️",info:"ℹ️"},a=document.createElement("div");a.innerHTML=`
    <div style="display: flex; align-items: center; gap: 8px;">
      <span style="font-size: 18px;">${s[t]}</span>
      <span>${e}</span>
    </div>
  `,Object.assign(a.style,{position:"fixed",top:"20px",left:"20px",backgroundColor:o[t].bg,color:"white",padding:"16px 24px",borderRadius:"12px",zIndex:"10001",boxShadow:"0 8px 25px rgba(0,0,0,0.15)",fontSize:"15px",fontWeight:"500",minWidth:"300px",border:`2px solid ${o[t].border}`,backdropFilter:"blur(10px)",transform:"translateX(-100%)",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)",fontFamily:"system-ui, -apple-system, sans-serif",cursor:"pointer"}),document.body.appendChild(a),requestAnimationFrame(()=>{a.style.transform="translateX(0)"});const l=setTimeout(()=>{a.style.transform="translateX(-100%)",a.style.opacity="0",setTimeout(()=>{a.parentNode&&a.remove()},300)},n);a.addEventListener("click",()=>{clearTimeout(l),a.style.transform="translateX(-100%)",a.style.opacity="0",setTimeout(()=>a.remove(),300)}),a.addEventListener("mouseenter",()=>{a.style.transform="translateX(0) scale(1.02)"}),a.addEventListener("mouseleave",()=>{a.style.transform="translateX(0) scale(1)"})}const en="857019088708-tlju4p4u0731nsoa7k05ncr56o4k75ds.apps.googleusercontent.com",tn="https://www.googleapis.com/auth/drive.file",nn=["https://veron3373.github.io","http://localhost:3000","http://127.0.0.1:3000","http://localhost:5173","http://127.0.0.1:5173","http://localhost:8080","http://127.0.0.1:8080"];let je=null;function Q(e){return e instanceof Error?e:typeof e=="string"?new Error(e):new Error("Невідома помилка")}function on(){const e=window.location.origin;return nn.includes(e)}function ce(e){if(typeof e=="string")try{return JSON.parse(e)}catch{return null}return e}function He(e){return e.replace(/[^\p{L}\p{N}\s.-]/gu,"").replace(/\s+/g,"_").replace(/_{2,}/g,"_").replace(/^_|_$/g,"")}async function an(){return new Promise((e,t)=>{if(typeof google<"u"&&typeof gapi<"u"){e();return}const n=document.createElement("script");n.src="https://accounts.google.com/gsi/client",n.async=!0,n.defer=!0,n.onload=()=>{const o=document.createElement("script");o.src="https://apis.google.com/js/api.js",o.async=!0,o.defer=!0,o.onload=()=>e(),o.onerror=()=>t(new Error("Не вдалося завантажити GAPI скрипт.")),document.head.appendChild(o)},n.onerror=()=>t(new Error("Не вдалося завантажити Google Identity Services скрипт.")),document.head.appendChild(n)})}async function sn(){try{if(!on())throw new Error(`Домен ${window.location.origin} не дозволено для використання Google Drive.`);return await an(),await new Promise((e,t)=>{gapi.load("client",{callback:e,onerror:()=>t(new Error("Помилка завантаження клієнтської бібліотеки GAPI."))})}),new Promise((e,t)=>{google.accounts.oauth2.initTokenClient({client_id:en,scope:tn,callback:async o=>{if(o.error||!o.access_token)return t(new Error(o.error||"Не вдалося отримати токен доступу Google Drive."));je=o.access_token,gapi.client.setToken(o);try{await gapi.client.init({}),await gapi.client.load("drive","v3"),await fn(),e()}catch(s){t(Q(s))}},error_callback:o=>t(Q(o))}).requestAccessToken()})}catch(e){throw Q(e)}}async function nt(e,t={}){var s;if(!je)throw console.error("Спроба викликати Drive API без токена доступу."),new Error("Відсутній токен доступу для Google Drive. Будь ласка, авторизуйтесь.");const n={Authorization:`Bearer ${je}`,...t.headers};t.method!=="GET"&&t.method!==void 0&&(n["Content-Type"]="application/json");const o=await fetch(`https://www.googleapis.com/drive/v3${e}`,{...t,headers:n});if(!o.ok){const a=await o.text();throw console.error(`Помилка Drive API ${o.status}: ${o.statusText}`,a),new Error(`Помилка Google Drive API: ${o.status} ${o.statusText}. Деталі: ${a.substring(0,200)}`)}return(s=o.headers.get("content-type"))!=null&&s.includes("application/json")?o.json():o.text()}async function rn(e,t=null){var n,o;try{const s=e.replace(/'/g,"\\'"),a=`'${t??"root"}' in parents and name = '${s}' and mimeType = 'application/vnd.google-apps.folder' and trashed = false`;return((o=(n=(await nt(`/files?q=${encodeURIComponent(a)}&fields=files(id,name)`)).files)==null?void 0:n[0])==null?void 0:o.id)||null}catch(s){return console.error(`Помилка пошуку папки '${e}':`,s),null}}async function Lt(e,t=null){try{const n={name:e,mimeType:"application/vnd.google-apps.folder",...t&&{parents:[t]}},o=await nt("/files?fields=id",{method:"POST",body:JSON.stringify(n)});if(!(o!=null&&o.id))throw new Error(`Не вдалося отримати ID нової папки '${e}'.`);return o.id}catch(n){throw Q(n)}}async function ln(e,t=null){try{console.log(`Пошук або створення папки: '${e}' в батьківській папці ID: ${t||"root"}`);const n=await rn(e,t);return n?(console.log(`Знайдено існуючу папку: '${e}' з ID: ${n}`),n):(console.log(`Папку '${e}' не знайдено. Створюємо нову.`),await Lt(e,t))}catch(n){throw Q(n)}}async function cn(e){try{const{data:t,error:n}=await _.from("acts").select("*").eq("act_id",e).single();if(n||!t)throw new Error(`Не вдалося знайти акт з ID ${e}: ${(n==null?void 0:n.message)||"дані відсутні"}`);let o={fio:"Невідомий_клієнт",phone:"Без_телефону"};if(t.client_id){const{data:a,error:l}=await _.from("clients").select("*").eq("client_id",t.client_id).single();if(!l&&a){const r=a.data||a,i=ce(r.data||r),d=(i==null?void 0:i.ПІБ)||(i==null?void 0:i.fio)||(r==null?void 0:r.fio)||a.fio||"Невідомий_клієнт",c=(i==null?void 0:i.Телефон)||(i==null?void 0:i.phone)||(r==null?void 0:r.phone)||a.phone||"Без_телефону";o={fio:String(d).trim()||"Невідомий_клієнт",phone:String(c).trim()||"Без_телефону"}}}let s={auto:"Невідоме_авто",year:"0000"};if(t.cars_id){const{data:a,error:l}=await _.from("cars").select("*").eq("cars_id",t.cars_id).single();if(!l&&a){const r=a.data||a,i=ce(r.data||r),d=(i==null?void 0:i.Авто)||(i==null?void 0:i.auto)||(r==null?void 0:r.auto)||a.auto||"Невідоме_авто",c=(i==null?void 0:i.Рік)||(i==null?void 0:i.year)||(r==null?void 0:r.year)||a.year||"0000";s={auto:String(d).trim()||"Невідоме_авто",year:String(c).trim()||"0000"}}}return{act_id:e,date_on:t.date_on,fio:o.fio,phone:o.phone,car:s.auto,year:s.year,act_data:t}}catch(t){throw console.error("Помилка отримання повної інформації про акт:",t),Q(t)}}async function dn(e,t){try{console.log(`Оновлення посилання для акту ${e}: ${t}`);const{data:n,error:o}=await _.from("acts").select("data").eq("act_id",e).single();if(o)throw new Error(`Не вдалося отримати акт з ID ${e} для оновлення посилання: ${o.message}`);if(!n)throw new Error(`Акт з ID ${e} не знайдено для оновлення посилання.`);const s=ce(n.data)||{};s.Фото=[t];const{error:a}=await _.from("acts").update({data:s}).eq("act_id",e);if(a)throw new Error(`Помилка оновлення посилання для акту ${e}: ${a.message}`);console.log(`Посилання на папку для акту ${e} успішно оновлено.`)}catch(n){throw console.error("Критична помилка при оновленні посилання на папку в БД:",n),Q(n)}}function un(e=!1){const t=document.getElementById("open-google-drive-folder");if(!t){console.warn('Кнопка "open-google-drive-folder" не знайдена.');return}t.removeEventListener("click",n),t.addEventListener("click",n);async function n(o){o.preventDefault();const s=document.getElementById("zakaz_narayd-custom-modal"),a=s==null?void 0:s.getAttribute("data-act-id");if(!a){E("Не вдалося отримати ID акту з модального вікна.","error");return}try{E("Перевірка статусу фотографій...","info");const{data:l,error:r}=await _.from("acts").select("data, date_off").eq("act_id",Number(a)).single();if(r||!l){E("Помилка отримання даних акту з БД.","error"),console.error("Помилка отримання акту для обробника Google Drive:",r);return}const i=ce(l.data)||{},d=Array.isArray(i==null?void 0:i.Фото)?i.Фото:[];if(d.length>0&&d[0]){const f=d[0];E("Відкриваємо існуючу папку Google Drive...","success"),window.open(f,"_blank");return}if(!!l.date_off||e){E("Акт закритий — неможливо створити нову папку з фотографіями.","warning");return}E("Ініціалізація Google Drive та створення папки...","info"),await sn();const u=await cn(Number(a));await mn(u),E("Папку Google Drive успішно створено та відкрито!","success")}catch(l){console.error("❌ Google Drive помилка:",l),E(`Помилка: Не вдалося створити або відкрити папку. ${Q(l).message}`,"error")}}}async function mn({act_id:e,date_on:t,fio:n,phone:o,car:s,year:a}){try{const r=`${new Date(t).getFullYear()}`;console.log(`Початок створення структури папок для акту ID: ${e}`);const i=await ln(r),c=[`Акт_${e}`,n&&n!=="—"&&n!=="Невідомий_клієнт"?He(n):null,s&&s!=="—"&&s!=="Невідоме_авто"?He(s):null,a&&a!=="—"&&a!=="0000"?He(a):null,o&&o!=="—"&&o!=="Без_телефону"?He(o):null].filter(Boolean).join("_").substring(0,100).trim();if(!c)throw new Error("Не вдалося сформувати коректну назву папки для акту. Перевірте дані.");const u=await Lt(c,i);console.log(`Папку акту '${c}' створено з ID: ${u}`);const f=`https://drive.google.com/drive/folders/${u}`;console.log(`Сформоване посилання на папку Drive: ${f}`),await dn(e,f),console.log(`Відкриваємо папку в новому вікні: ${f}`),window.open(f,"_blank"),E("Папка Google Drive успішно створена та посилання збережено.","success")}catch(l){const r=Q(l);console.error("Помилка під час створення структури папок Google Drive:",r),E(`Помилка створення папки Google Drive: ${r.message}`,"error")}}async function fn(){try{await nt("/files?pageSize=1&fields=files(id)"),console.log("Тестове з'єднання з Google Drive успішне.")}catch(e){throw Q(e)}}function pn(e,t){const n=e.querySelector("table.left tr:nth-child(3) td:nth-child(2)");!n||!t||t.trim()==="—"||(n.style.cursor="pointer",n.title="Натисніть, щоб зателефонувати",n.style.textDecoration="none",n.style.color="blue",n.addEventListener("click",()=>{const o=t.replace(/\D/g,"");/Android|iPhone|iPad|iPod|BlackBerry|Windows Phone/i.test(navigator.userAgent)?confirm(`Ви бажаєте зателефонувати на номер ${t}?`)?(window.location.href=`tel:${o}`,E(`Виклик номера ${t}...`,"info",2e3)):E("Дзвінок скасовано.","warning",1500):confirm(`Ви бажаєте спробувати зателефонувати на номер ${t}?

На комп'ютері для цього потрібна встановлена програма (наприклад, Skype, Zoom), яка може обробляти телефонні посилання.`)?(window.location.href=`tel:${o}`,E(`Спроба виклику номера ${t}...`,"info",3e3),setTimeout(()=>{},3500)):E("Спроба дзвінка скасована.","warning",1500)}))}function gn(e){const t=document.getElementById(e);if(!t){console.warn(`Елемент з ID '${e}' не знайдено для ініціалізації одометра.`);return}const n=s=>{let a=s.replace(/\D/g,""),l=parseInt(a,10);const r=1e6;return isNaN(l)||l<0?l=0:l>r&&(l=r),l.toString().replace(/\B(?=(\d{3})+(?!\d))/g," ")},o=t.textContent||"";t.textContent=n(o),t.addEventListener("input",s=>{const a=s.target,l=a.textContent||"",r=n(l),i=window.getSelection();let d=0;i&&i.rangeCount>0&&(d=i.getRangeAt(0).startOffset);let c=0;for(let m=0;m<l.length&&m<d;m++)/\d/.test(l[m])&&c++;let u=0,f=0;for(let m=0;m<r.length;m++)if(/\d/.test(r[m])&&f++,f===c){u=m+1;break}if(u===0&&c>0?u=r.length:l.replace(/\D/g,"").length===0&&(u=0),a.textContent=r,i){const m=document.createRange(),g=a.firstChild;if(g&&g.nodeType===Node.TEXT_NODE){const w=Math.min(u,r.length);m.setStart(g,w),m.setEnd(g,w),i.removeAllRanges(),i.addRange(m)}else m.selectNodeContents(a),m.collapse(!1),i.removeAllRanges(),i.addRange(m)}}),t.addEventListener("blur",s=>{const a=s.target,l=a.textContent||"";a.textContent=n(l)})}const y={works:[],details:[],slyusars:[],shops:[],settings:{showPibMagazin:!0},isActClosed:!1,currentActId:null},Ze="zakaz_narayd-custom-modal",Ge="zakaz_narayd-body",yt="zakaz_narayd-close",xt="save-act-data",Re="editable-probig",At="editable-reason",Bt="editable-recommendations",ht="open-google-drive-folder",ye="act-items-table-container";function H(e,t=0,n=2){if(e==null||String(e).trim()==="")return"";const o=parseFloat(String(e).replace(",","."));return isNaN(o)?String(e):new Intl.NumberFormat("uk-UA",{minimumFractionDigits:t,maximumFractionDigits:n}).format(o)}async function zt(){try{const[{data:e},{data:t},{data:n},{data:o}]=await Promise.all([_.from("works").select("data"),_.from("details").select("data"),_.from("slyusars").select("data"),_.from("shops").select("data")]),{data:s,error:a}=await _.from("settings").select("data").eq("setting_id",1).single();a&&console.warn("⚠️ Не вдалося отримати налаштування 'settings':",a.message),y.works=(e==null?void 0:e.map(l=>l.data||"").filter(Boolean))||[],y.details=(t==null?void 0:t.map(l=>l.data||"").filter(Boolean))||[],y.slyusars=(n==null?void 0:n.map(l=>{const r=ce(l.data);return r!=null&&r.Name?r:null}).filter(Boolean))||[],y.shops=(o==null?void 0:o.map(l=>{const r=ce(l.data);return r!=null&&r.Name?r:null}).filter(Boolean))||[],y.settings={showPibMagazin:(s==null?void 0:s.data)===!0}}catch(e){console.error("❌ Помилка завантаження глобальних даних:",e),E("Помилка завантаження базових даних","error")}}function We(e){var r;const t=e.closest("tr"),n=t==null?void 0:t.querySelector('[data-name="name"]'),o=((r=n==null?void 0:n.textContent)==null?void 0:r.trim())||"",s=y.details.some(i=>i.toLowerCase()===o.toLowerCase()),a=y.works.some(i=>i.toLowerCase()===o.toLowerCase());let l="";return s&&!a?l="shops":a&&!s?l="slyusars":l="",e.setAttribute("data-type",l),l}function ot(e,t){const n=document.getElementById(e);n&&(n.addEventListener("focusin",o=>{var d,c;const s=o.target;if(!s.classList.contains("editable-autocomplete")||t.isActClosed)return;const a=((d=s.textContent)==null?void 0:d.trim().toLowerCase())||"";let l=s.getAttribute("data-type");const r=s.getAttribute("data-name");let i=[];r==="name"?i=[...t.details,...t.works]:r==="pib_magazin"?(l=We(s),l==="shops"?i=t.shops.map(u=>u.Name):l==="slyusars"&&(i=t.slyusars.map(u=>u.Name))):l==="shops"?i=t.shops.map(u=>u.Name):l==="slyusars"&&(i=t.slyusars.map(u=>u.Name)),a===""&&i.length>0&&document.querySelector(".autocomplete-list")===null?vt(s,i):a!==""&&document.querySelector(".autocomplete-list")===null&&((c=document.querySelector(".autocomplete-list"))==null||c.remove(),window.removeEventListener("scroll",he))}),n.addEventListener("input",o=>{var d,c,u,f;const s=o.target;if(!s.classList.contains("editable-autocomplete")||t.isActClosed){(d=document.querySelector(".autocomplete-list"))==null||d.remove();return}const a=((c=s.textContent)==null?void 0:c.trim().toLowerCase())||"";let l=s.getAttribute("data-type");const r=s.getAttribute("data-name");let i=[];if(r==="name"){const m=t.details.filter(x=>x.toLowerCase().includes(a)),g=t.works.filter(x=>x.toLowerCase().includes(a));i=[...m,...g];const w=s.closest("tr"),I=w==null?void 0:w.querySelector('[data-name="pib_magazin"]');if(I){const x=((u=I.textContent)==null?void 0:u.trim())||"",N=We(I);(N==="slyusars"&&!t.slyusars.map(T=>T.Name.toLowerCase()).includes(x.toLowerCase())&&x!==""||N==="shops"&&!t.shops.map(T=>T.Name.toLowerCase()).includes(x.toLowerCase())&&x!==""||a.length===0)&&(I.textContent="")}}else r==="pib_magazin"?(l=We(s),l==="shops"?i=t.shops.map(m=>m.Name).filter(m=>m.toLowerCase().includes(a)):l==="slyusars"&&(i=t.slyusars.map(m=>m.Name).filter(m=>m.toLowerCase().includes(a)))):l==="shops"?i=t.shops.map(m=>m.Name).filter(m=>m.toLowerCase().includes(a)):l==="slyusars"&&(i=t.slyusars.map(m=>m.Name).filter(m=>m.toLowerCase().includes(a)));i.length>0?vt(s,i):((f=document.querySelector(".autocomplete-list"))==null||f.remove(),window.removeEventListener("scroll",he))}),n.addEventListener("focusout",o=>{const s=o.relatedTarget;s&&s.closest(".autocomplete-list")||setTimeout(()=>{var a,l;!((a=document.activeElement)!=null&&a.closest(".autocomplete-list"))&&document.activeElement!==xe&&((l=document.querySelector(".autocomplete-list"))==null||l.remove(),window.removeEventListener("scroll",he))},100)}))}let xe=null,_e=null;function he(){if(_e&&xe){const e=xe.getBoundingClientRect();e.top>=0&&e.left>=0&&e.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&e.right<=(window.innerWidth||document.documentElement.clientWidth)?(_e.style.top=`${e.bottom+window.scrollY}px`,_e.style.left=`${e.left+window.scrollX}px`):(_e.remove(),_e=null,xe=null,window.removeEventListener("scroll",he))}else window.removeEventListener("scroll",he)}function vt(e,t){var s;if((s=document.querySelector(".autocomplete-list"))==null||s.remove(),window.removeEventListener("scroll",he),t.length===0)return;const n=document.createElement("ul");n.className="autocomplete-list",t.forEach(a=>{const l=document.createElement("li");l.textContent=a,l.className="autocomplete-item",l.tabIndex=0,l.addEventListener("mousedown",r=>{if(r.preventDefault(),e.textContent=a,n.remove(),_e=null,xe=null,window.removeEventListener("scroll",he),e.getAttribute("data-name")==="name"){const i=a,d=e.closest("tr"),c=d==null?void 0:d.querySelector('[data-name="pib_magazin"]');if(c){const u=y.details.some(g=>g===i),f=y.works.some(g=>g===i);let m="";u?(m="shops",e.setAttribute("data-type","details")):f?(m="slyusars",e.setAttribute("data-type","works")):e.removeAttribute("data-type"),c.setAttribute("data-type",m),c.textContent=""}}e.dispatchEvent(new Event("input",{bubbles:!0})),e.focus()}),n.appendChild(l)});const o=e.getBoundingClientRect();n.style.position="absolute",n.style.top=`${o.bottom+window.scrollY}px`,n.style.left=`${o.left+window.scrollX}px`,n.style.minWidth=`${o.width}px`,n.style.zIndex="9999",document.body.appendChild(n),xe=e,_e=n,window.addEventListener("scroll",he)}const Fe="vikno_pidtverdchennay_zakruttia_akty-modal";function yn(){const e=document.createElement("div");e.id=Fe,e.className="vikno_pidtverdchennay_zakruttia_akty-overlay",e.style.display="none";const t=document.createElement("div");return t.className="vikno_pidtverdchennay_zakruttia_akty-content",t.innerHTML=`
    <p>Підтвердіть закриття акту?</p>
    <div class="vikno_pidtverdchennay_zakruttia_akty-buttons save-buttons">
      <button id="vikno_pidtverdchennay_zakruttia_akty-confirm" class="vikno_pidtverdchennay_zakruttia_akty-confirm-btn btn-save-confirm">Так</button>
      <button id="vikno_pidtverdchennay_zakruttia_akty-cancel" class="vikno_pidtverdchennay_zakruttia_akty-cancel-btn btn-save-cancel">Ні</button>
    </div>`,e.appendChild(t),e}function hn(e){return console.log("Закриття акту ID:",e),new Promise(t=>{const n=document.getElementById(Fe);if(!n)return console.error(`Модальне вікно з ID "${Fe}" не знайдено.`),t(!1);n.style.display="flex";const o=document.getElementById("vikno_pidtverdchennay_zakruttia_akty-confirm"),s=document.getElementById("vikno_pidtverdchennay_zakruttia_akty-cancel");if(!o||!s)return console.error("Кнопки підтвердження або скасування не знайдені в модальному вікні."),n.style.display="none",t(!1);const a=()=>{n.style.display="none",o.removeEventListener("click",l),s.removeEventListener("click",r)},l=()=>{a(),t(!0)},r=()=>{a(),t(!1)};o.addEventListener("click",l),s.addEventListener("click",r)})}const Ve="vikno_vvody_parolu-modal";function vn(){const e=document.createElement("div");e.id=Ve,e.className="vikno_vvody_parolu-overlay",e.style.display="none";const t=document.createElement("div");return t.className="vikno_vvody_parolu-content modal-content-save",t.innerHTML=`
    <p>Введіть пароль для відкриття акту:</p>
    <input type="password" id="password-input" placeholder="Пароль" class="password-input" style="padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 8px; width: calc(100% - 20px);">
    <div class="vikno_vvody_parolu-buttons save-buttons">
      <button id="password-confirm-btn" class="btn-save-confirm">Підтвердити</button>
      <button id="password-cancel-btn" class="btn-save-cancel">Скасувати</button>
    </div>
  `,e.appendChild(t),e}function bn(){return new Promise(e=>{const t=document.getElementById(Ve);if(!t)return console.error(`Модальне вікно вводу пароля з ID "${Ve}" не знайдено.`),e(!1);t.style.display="flex";const n=document.getElementById("password-input"),o=document.getElementById("password-confirm-btn"),s=document.getElementById("password-cancel-btn");n.value="",n.focus();const a=()=>{t.style.display="none",o.removeEventListener("click",l),s.removeEventListener("click",r),n.removeEventListener("keypress",i)},l=()=>{n.value==="1111"?(E("Пароль вірний","success",1e3),a(),e(!0)):(E("Невірний пароль","error",1500),n.value="",n.focus())},r=()=>{a(),e(!1)},i=d=>{d.key==="Enter"&&l()};o.addEventListener("click",l),s.addEventListener("click",r),n.addEventListener("keypress",i)})}function _n(){if(document.getElementById(Ze))return;const e=document.createElement("div");e.id=Ze,e.className="zakaz_narayd-modal-overlay hidden",e.innerHTML=`
    <div class="zakaz_narayd-modal-content">
      <button class="zakaz_narayd-modal-close" id="${yt}">&times;</button>
      <div class="zakaz_narayd-modal-body" id="${Ge}"></div>
    </div>`,document.body.appendChild(e);const t=e.querySelector(`#${yt}`);t==null||t.addEventListener("click",()=>{var n;e.classList.add("hidden"),y.currentActId=null,(n=document.getElementById("add-row-button"))==null||n.remove()})}function En(e){var s,a;const t=e.querySelector('[data-name="price"]'),n=e.querySelector('[data-name="id_count"]'),o=e.querySelector('[data-name="sum"]');if(t&&n&&o){const l=((s=t.textContent)==null?void 0:s.trim())||"0",r=((a=n.textContent)==null?void 0:a.trim())||"0",i=parseFloat(l)||0,d=parseFloat(r)||0,c=i*d;o.textContent=H(Math.round(c),0,0),De()}}function wn(e){const t=document.getElementById(e);if(!t)return;const n=t.querySelector("tbody");if(!n)return;const o=document.createElement("tr"),s=n.children.length+1,a=y.settings.showPibMagazin?`<td contenteditable="${!y.isActClosed}" class="editable-autocomplete" data-name="pib_magazin" data-type=""></td>`:"";o.innerHTML=`
    <td>${s}</td>
    <td contenteditable="${!y.isActClosed}" class="editable-autocomplete" data-name="name" data-type=""></td>
    <td contenteditable="${!y.isActClosed}" class="text-right" data-name="id_count"></td>
    <td contenteditable="${!y.isActClosed}" class="text-right" data-name="price"></td>
    <td class="text-right" data-name="sum">${H(0)}</td>
    ${a}
  `,n.appendChild(o),y.isActClosed||ot(e,y),De()}function Cn(e,t){const n=t?"<th>ПІБ _ Магазин</th>":"";let o="";if(e.length>0)o=e.map((l,r)=>{const i=parseFloat(l.price)||0,d=parseFloat(l.quantity)||0,c=parseFloat(l.sum)||0,u=t?`<td contenteditable="${!y.isActClosed}" class="editable-autocomplete" data-name="pib_magazin" data-type="${l.type==="detail"?"shops":"slyusars"}">${l.person_or_store||""}</td>`:"",f=l.type==="detail"?"details":"works";return`
          <tr>
            <td>${r+1}</td>
            <td contenteditable="${!y.isActClosed}" class="editable-autocomplete" data-name="name" data-type="${f}">${l.name||""}</td>
            <td contenteditable="${!y.isActClosed}" class="text-right" data-name="id_count">${H(d)}</td>
            <td contenteditable="${!y.isActClosed}" class="text-right" data-name="price">${H(Math.round(i))}</td>
            <td class="text-right" data-name="sum">${H(Math.round(c))}</td>
            ${u}
          </tr>
        `}).join("");else{const l=t?`<td contenteditable="${!y.isActClosed}" class="editable-autocomplete" data-name="pib_magazin" data-type=""></td>`:"";o=`
      <tr>
        <td>1</td>
        <td contenteditable="${!y.isActClosed}" class="editable-autocomplete" data-name="name" data-type=""></td>
        <td contenteditable="${!y.isActClosed}" class="text-right" data-name="id_count"></td>
        <td contenteditable="${!y.isActClosed}" class="text-right" data-name="price"></td>
        <td class="text-right" data-name="sum">${H(0)}</td>
        ${l}
      </tr>
      `}const s=`
    <div class="zakaz_narayd-sums-footer">
      <p><strong>За роботу:</strong> <span class="zakaz_narayd-sums-footer-sum" id="total-works-sum">${H(0)}</span> грн</p>
      <p><strong>За деталі:</strong> <span class="zakaz_narayd-sums-footer-sum" id="total-details-sum">${H(0)}</span> грн</p>
      <p><strong>Загальна сума:</strong> <span class="zakaz_narayd-sums-footer-total" id="total-overall-sum">${H(0)}</span> грн</p>
    </div>`,a=y.isActClosed?"":`
    <div class="zakaz_narayd-buttons-container">
      <button id="add-row-button" class="action-button add-row-button">➕ Додати рядок</button>
      <button id="save-act-data" class="zakaz_narayd-save-button" style="padding: 0.5rem 1rem;"> 💾 Зберегти зміни</button>
    </div>`;return`
    <div class="zakaz_narayd-table-container-value" id="${ye}">
      <table class="zakaz_narayd-items-table">
        <thead>
          <tr>
            <th>№</th>
            <th>Найменування</th>
            <th class="text-right">К-ть</th>
            <th class="text-right">Ціна</th>
            <th class="text-right">Сума</th>
            ${n}
          </tr>
        </thead>
        <tbody>
          ${o}
        </tbody>
      </table>
      ${s}
      ${a}
    </div>`}function se(e,t,n=""){return`<tr><td>${e}</td><td${n?` class="${n}"`:""}>${t}</td></tr>`}function De(){const e=document.querySelector(`#${ye} tbody`);if(!e)return;let t=0,n=0;const o=new Set(y.details),s=new Set(y.works);e.querySelectorAll("tr").forEach((i,d)=>{var x,N;const c=i.querySelector('[data-name="name"]'),u=i.querySelector('[data-name="sum"]'),f=i.querySelector("td:first-child");if(!c||!u||!f)return;const m=((x=c.textContent)==null?void 0:x.trim())||"",g=((N=u.textContent)==null?void 0:N.replace(/\s/g,""))||"0",w=parseFloat(g)||0;let I=c.getAttribute("data-type");if(!I||I!=="details"&&I!=="works"){const T=o.has(m),O=s.has(m);T&&!O?I="details":O&&!T?I="works":O&&T?I="ambiguous":I="details",c.setAttribute("data-type",I)}I==="details"?(n+=w,f.textContent=`⚙️ ${d+1}`):I==="works"?(t+=w,f.textContent=`🛠️ ${d+1}`):f.textContent=`${d+1}`});const a=document.getElementById("total-works-sum"),l=document.getElementById("total-details-sum"),r=document.getElementById("total-overall-sum");a&&(a.textContent=H(Math.round(t),0,0)),l&&(l.textContent=H(Math.round(n),0,0)),r&&(r.textContent=H(Math.round(t+n),0,0))}const at="save-prompt-modal";function kn(){const e=document.createElement("div");e.id=at,e.className="modal-overlay-save",e.style.display="none";const t=document.createElement("div");return t.className="modal-content-save",t.innerHTML=`<p>Підтвердіть!!!</p>
    <div class="save-buttons">
      <button id="save-confirm" class="btn-save-confirm">Так</button>
      <button id="save-cancel" class="btn-save-cancel">Ні</button>
    </div>`,e.appendChild(t),e}const In=async()=>{const e=document.getElementById("search-input-all_other_bases");e&&(e.value="");const t=document.getElementById("custom-dropdown-all_other_bases");t&&(t.innerHTML="",t.classList.add("hidden-all_other_bases"))};function $n(){const e=document.getElementById("search-input-all_other_bases");return e?e.value.trim():""}async function Sn(){if(!U)return console.error("Відсутня змінна CRUD"),!1;if(!G)return console.error("Відсутні дані all_bd"),!1;const e=$n();if((U==="Редагувати"||U==="Додати")&&!e)return console.error("Відсутнє значення в інпуті для операції:",U),!1;try{const t=JSON.parse(G),n=t.table;if(!n)return console.error("Відсутня назва таблиці в all_bd"),!1;switch((U==="Редагувати"||U==="Видалити")&&(t.record={...t}),U){case"Редагувати":return await Ln(n,t,e);case"Видалити":return await xn(n,t);case"Додати":return await An(n,e);default:return console.error("Невідомий CRUD режим:",U),!1}}catch(t){return console.error("Помилка при обробці CRUD операції:",t),!1}}async function Ln(e,t,n){try{if(!t.record)return console.error("Немає знайденого запису для редагування"),!1;const o=Object.keys(t.record).find(d=>d.includes("_id")||d==="id");if(!o)return console.error("Не знайдено ID поле для редагування"),!1;const s=t.record[o];console.log(`Редагування: ${e}, ID поле: ${o}, ID значення: ${s}`);const{data:a,error:l}=await _.from(e).select("*").eq(o,s).single();if(l||!a)return console.error("Помилка при отриманні запису:",l),!1;let r={};if(e==="incomes"||e==="receivers"||e==="shops"||e==="slyusars")r.data=JSON.stringify({Name:n});else if(["works","details"].includes(e))r.data=n;else return console.error("Невідома таблиця для редагування:",e),!1;const{error:i}=await _.from(e).update(r).eq(o,s);return i?(console.error("Помилка при редагуванні:",i),!1):(console.log(`Успішно відредаговано: ${e}, ID: ${s}, нове значення: "${n}"`),!0)}catch(o){return console.error("Помилка при редагуванні:",o),!1}}async function xn(e,t){try{if(!t.record)return console.error("Немає знайденого запису для видалення"),!1;const n=Object.keys(t.record).find(a=>a.includes("_id")||a==="id");if(!n)return console.error("Не знайдено ID поле для видалення"),!1;const o=t.record[n];console.log(`Видалення: ${e}, ID поле: ${n}, ID значення: ${o}`);const{error:s}=await _.from(e).delete().eq(n,o);return s?(console.error("Помилка при видаленні:",s),!1):(console.log(`Успішно видалено: ${e}, ID: ${o}`),!0)}catch(n){return console.error("Помилка при видаленні:",n),!1}}async function An(e,t){try{console.log(`Додавання до таблиці: ${e}, значення: "${t}"`);let n={},o;const a={incomes:"income_id",receivers:"receiver_id",shops:"shop_id",slyusars:"slyusar_id",works:"work_id",details:"detail_id"}[e];if(!a)return console.error("Невідома таблиця для отримання ID:",e),!1;const{data:l,error:r}=await _.from(e).select(a).order(a,{ascending:!1}).limit(1);if(r)return console.error("Помилка при отриманні максимального ID:",r),!1;const i=l==null?void 0:l[0];if(o=((i==null?void 0:i[a])??0)+1,["incomes","receivers","shops","slyusars"].includes(e))n={[a]:o,data:JSON.stringify({Name:t})};else if(["works","details"].includes(e))n={[a]:o,data:t};else return console.error("Невідома таблиця для додавання:",e),!1;console.log("Дані для вставки:",n);const{error:d}=await _.from(e).insert(n).select();return d?(console.error("Помилка при додаванні:",d),!1):(console.log(`✅ Успішно додано: ${e}, значення: "${t}"`),!0)}catch(n){return console.error("❌ Помилка при додаванні:",n),!1}}function Bn(){return new Promise(e=>{const t=document.getElementById(at);if(!t)return e(!1);t.style.display="flex";const n=document.getElementById("save-confirm"),o=document.getElementById("save-cancel"),s=()=>{t.style.display="none",n.removeEventListener("click",r),o.removeEventListener("click",i)},a=(d,c)=>{const u=document.createElement("div");u.textContent=d,u.style.position="fixed",u.style.top="50%",u.style.left="50%",u.style.transform="translateX(-50%)",u.style.backgroundColor=c,u.style.color="white",u.style.padding="12px 24px",u.style.borderRadius="8px",u.style.zIndex="10001",u.style.boxShadow="0 4px 12px rgba(0,0,0,0.2)",document.body.appendChild(u),setTimeout(()=>{u.remove()},1500)},l=()=>{document.querySelectorAll(".modal-overlay-all_other_bases").forEach(d=>d.classList.add("hidden-all_other_bases"))},r=async()=>{if(!U){s(),a("❌ Помилка: відсутня змінна CRUD","#f44336"),e(!1);return}const d=await Sn();s(),l(),d?(a("✅ Дані успішно відредаговані","#4caf50"),await In(),document.dispatchEvent(new CustomEvent("other-base-data-updated")),e(!0)):(a("❌ Помилка при редагуванні даних","#f44336"),e(!1))},i=()=>{s(),a("✖ Скасовано користувачем","#f44336"),e(!1)};n.addEventListener("click",r),o.addEventListener("click",i)})}let G=null,U="",Te=[],Ye=null;document.addEventListener("DOMContentLoaded",()=>{if(!document.getElementById(at)){const t=kn();document.body.appendChild(t)}});const zn={Робота:{table:"works",field:"data"},Деталі:{table:"details",field:"data"},Джерело:{table:"incomes",field:"data",deepPath:["Name"],needsJsonParsing:!0},Приймальник:{table:"receivers",field:"data",deepPath:["Name"],needsJsonParsing:!0},Магазини:{table:"shops",field:"data",deepPath:["Name"],needsJsonParsing:!0},Слюсар:{table:"slyusars",field:"data",deepPath:["Name"],needsJsonParsing:!0}},Ke=(e,t)=>t.reduce((n,o)=>n&&n[o]!==void 0?n[o]:void 0,e),bt=(e,t=!1)=>{if(!e.trim())return;if(!Ye){G=null;return}const{table:n,field:o,deepPath:s,needsJsonParsing:a}=Ye;let l=!1;if(Te&&Te.length>0)for(const r of Te){let i=r;if(a&&typeof r[o]=="string")try{i={...r,[o]:JSON.parse(r[o])}}catch{continue}let d;if(s?d=Ke(i[o],s):(d=a||typeof r[o]=="object"?i[o]:r[o],typeof d=="object"?d=JSON.stringify(d):typeof d!="string"&&(d=String(d))),(d==null?void 0:d.trim())===e.trim()){l=!0;const u=`${n.endsWith("s")?n.slice(0,-1):n}_id`,f=r[u]!==void 0?r[u]:null;let m;if(a&&typeof r[o]=="string")try{m=JSON.parse(r[o])}catch{m=r[o]}else m=r[o];const g={table:n,[u]:f,data:s&&s.length===1?{[s[0]]:Ke(m,s)}:typeof m=="object"&&!Array.isArray(m)?m:{[o]:m}};G=JSON.stringify(g,null,2);return}}if(!l&&t){const i=`${n.endsWith("s")?n.slice(0,-1):n}_id`,d={table:n,[i]:null,data:s&&s.length===1?{[s[0]]:e.trim()}:{[o]:e.trim()}};G=JSON.stringify(d,null,2)}},_t=e=>{U=e},Mn=(e,t)=>{const n=document.getElementById("current-table-name");n&&(n.textContent=`Поточна таблиця: ${e} (${t})`)},Tn=(e,t,n,o,s)=>{const a=document.getElementById("custom-dropdown-all_other_bases");if(!a||!n)return;Te=e;const l=e.map(c=>{let u=c;if(s&&typeof c[t]=="string")try{u={...c,[t]:JSON.parse(c[t])}}catch{return null}let f;return o?f=Ke(s?u[t]:c[t],o):f=s||typeof c[t]=="object"?u[t]:c[t],f!=null?String(f).trim():null}).filter(c=>typeof c=="string"&&c.length>0),r=[...new Set(l)].sort(),i=c=>{a.innerHTML="";const u=r.filter(f=>f.toLowerCase().includes(c.toLowerCase()));if(u.length===0){a.classList.add("hidden-all_other_bases");return}u.forEach(f=>{const m=document.createElement("div");m.className="custom-dropdown-item",m.textContent=f,m.addEventListener("click",()=>{n.value=f,a.classList.add("hidden-all_other_bases"),bt(f,!0)}),a.appendChild(m)}),a.classList.remove("hidden-all_other_bases")};n.addEventListener("input",()=>{i(n.value.trim()),bt(n.value.trim(),!1)}),n.addEventListener("focus",()=>{i(n.value.trim())}),document.addEventListener("click",c=>{!a.contains(c.target)&&c.target!==n&&a.classList.add("hidden-all_other_bases")});const d=n.getBoundingClientRect();a.style.minWidth=`${d.width}px`},st=async e=>{const t=zn[e];if(t){Ye=t;try{const n=document.getElementById("search-input-all_other_bases");n&&(n.value=""),G=JSON.stringify({config:t,table:t.table,input:""},null,2),Mn(e,t.table);const{data:o,error:s}=await _.from(t.table).select("*");if(s||!o)throw new Error((s==null?void 0:s.message)||"Дані не отримані");Tn(o,t.field,n,t.deepPath,t.needsJsonParsing)}catch(n){console.error(`Помилка завантаження з ${e}`,n)}}};document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll(".toggle-button-all_other_bases").forEach(e=>{e.addEventListener("click",async()=>{var n;document.querySelectorAll(".toggle-button-all_other_bases").forEach(o=>o.classList.remove("active-all_other_bases")),e.classList.add("active-all_other_bases");const t=((n=e.textContent)==null?void 0:n.trim())||"";t&&await st(t)})})});document.addEventListener("DOMContentLoaded",()=>{const e=()=>{document.querySelectorAll(".modal-overlay-all_other_bases").forEach(g=>g.classList.add("hidden-all_other_bases"))},t=document.createElement("div");t.className="modal-overlay-all_other_bases hidden-all_other_bases",t.innerHTML=`
    <div class="modal-all_other_bases">
      <button class="modal-close-all_other_bases">×</button>
      <div class="modal-content-all_other_bases">
        <div class="modal-left-all_other_bases">
          <button class="toggle-button-all_other_bases">Деталі</button>
          <button class="toggle-button-all_other_bases">Робота</button>
          <button class="toggle-button-all_other_bases">Магазини</button>
          <button class="toggle-button-all_other_bases">Слюсар</button>
          <button class="toggle-button-all_other_bases">Приймальник</button>
          <button class="toggle-button-all_other_bases">Джерело</button>
        </div>
        <div class="modal-right-all_other_bases">
           <label for="search-input-all_other_bases" class="label-all_other_bases">Введіть дані для пошуку</label>
           <div id="modeToggleLabel" style="cursor: pointer; font-weight: bold; color: orange;">Редагувати</div>
           <div style="position: relative; width: 100%;">
            <input type="text" id="search-input-all_other_bases" class="input-all_other_bases" />
             <div id="custom-dropdown-all_other_bases" class="custom-dropdown hidden-all_other_bases"></div>
             <span id="modeIconSwitcher" class="confirm-button-all_other_bases edit" style="position: absolute; right: 10px; top: 10px; font-size: 24px; cursor: pointer; color: orange;">🔁</span>
        </div>
  <div class="yes-no-buttons-all_other_bases">
    <button class="yes-button-all_other_bases">Ок</button>

  </div>
</div>

      </div>
    </div>
  `,document.body.appendChild(t);const n=t.querySelector(".yes-button-all_other_bases");n&&n.addEventListener("click",async()=>{try{if(await Bn()){t.classList.add("hidden-all_other_bases");const w=Array.from(document.querySelectorAll(".toggle-button-all_other_bases")).find(I=>{var x;return((x=I.textContent)==null?void 0:x.trim())==="Джерело"});w&&w.click()}}catch(g){console.error("Помилка при показі модального вікна підтвердження:",g)}});const o=t.querySelector(".debug-button-all_other_bases");o&&o.addEventListener("click",()=>{if(G&&typeof G=="string"&&G.startsWith("{"))try{const g=JSON.parse(G);console.log("Розпарсені дані:",g)}catch(g){console.log("Помилка парсингу JSON:",g)}else console.log("all_bd містить:",G);console.log("CRUD режим:",U),console.log("==================")});const s=t.querySelector(".no-button-all_other_bases");s&&s.addEventListener("click",()=>{t.classList.add("hidden-all_other_bases")});const a=t.querySelector(".modal-close-all_other_bases");a&&a.addEventListener("click",()=>{t.classList.add("hidden-all_other_bases")});const l=t.querySelectorAll(".toggle-button-all_other_bases");l.forEach(g=>{g.classList.add("inactive-all_other_bases"),g.addEventListener("click",async()=>{var I;l.forEach(x=>x.classList.remove("active-all_other_bases")),g.classList.add("active-all_other_bases");const w=((I=g.textContent)==null?void 0:I.trim())||"";w&&await st(w)})}),document.querySelectorAll('a.menu-link.all_other_bases[data-action="openClient"]').forEach(g=>{g.addEventListener("click",w=>{w.preventDefault(),e(),t.classList.remove("hidden-all_other_bases")})});const r=document.getElementById("modeToggleLabel"),i=["Редагувати","Додати","Видалити"],d=["orange","green","crimson"],c=["🔁","➕","❌"];let u=0;r&&(r.textContent=i[u],r.style.color=d[u],_t(i[u]));const f=()=>{u=(u+1)%i.length,r&&(r.textContent=i[u],r.style.color=d[u],_t(i[u]));const g=document.getElementById("modeIconSwitcher");g&&(g.textContent=c[u],g.style.color=d[u])};r&&r.addEventListener("click",f);const m=document.getElementById("modeIconSwitcher");m&&m.addEventListener("click",f)});const Dn=()=>{const e=document.getElementById("search-input-all_other_bases");e&&(e.value="");const t=document.getElementById("custom-dropdown-all_other_bases");t&&(t.innerHTML="",t.classList.add("hidden-all_other_bases")),G=null,Te=[],Ye=null};document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll(".toggle-button-all_other_bases").forEach(e=>{e.addEventListener("click",async()=>{var n;Dn(),document.querySelectorAll(".toggle-button-all_other_bases").forEach(o=>o.classList.remove("active-all_other_bases")),e.classList.add("active-all_other_bases");const t=((n=e.textContent)==null?void 0:n.trim())||"";if(t){const{data:{session:o}}=await _.auth.getSession();if(!o){alert("⛔ Доступ заблоковано , Ви не авторизовані");return}await st(t)}})})});function Nn(){const e=document.querySelector(".modal-overlay-all_other_bases");e&&e.classList.remove("hidden-all_other_bases")}function qn(e){const t=e.getFullYear(),n=(e.getMonth()+1).toString().padStart(2,"0"),o=e.getDate().toString().padStart(2,"0"),s=e.getHours().toString().padStart(2,"0"),a=e.getMinutes().toString().padStart(2,"0"),l=e.getSeconds().toString().padStart(2,"0");return`${t}-${n}-${o} ${s}:${a}:${l}`}const Et=e=>e?new Date(e).toLocaleString("uk-UA",{day:"2-digit",month:"2-digit",year:"2-digit",hour:"2-digit",minute:"2-digit"}):null;//!-*-*-*-*-*-*-*-**-*-*-*
async function Pn(){E("Генерація PDF...","info",2e3);const e=document.getElementById(Ge);if(!e){E("Тіло модального вікна не знайдено.","error");return}const t=document.createElement("div");t.style.position="absolute",t.style.left="-9999px",t.style.top="-9999px",t.style.width="auto",t.style.height="auto",t.style.padding="20px",document.body.appendChild(t);const n=e.cloneNode(!0);t.appendChild(n),n.classList.add("print-version");const o=y.settings.showPibMagazin;y.settings.showPibMagazin=!1,Mt(n,y.settings.showPibMagazin),[n.querySelector("#print-act-button"),n.querySelector("#add-row-button"),n.querySelector(`#${xt}`),n.querySelector("#status-lock-btn"),n.querySelector("#sklad"),n.querySelector(".modal-close-button"),n.querySelector(".modal-footer")].forEach(a=>a&&(a.style.display="none")),n.style.overflow="visible",n.style.height="auto",n.style.maxHeight="none";try{const a=await Zt(n,{scale:2,useCORS:!0,windowWidth:n.scrollWidth,windowHeight:n.scrollHeight}),l=a.toDataURL("image/png"),r=new Kt("p","mm","a4"),i=r.internal.pageSize.getWidth(),d=r.internal.pageSize.getHeight(),c=i,u=a.height*c/a.width,f=(i-c)/2;let m=0,g=u;for(r.addImage(l,"PNG",f,m,c,u),g-=d;g>0;)m=g-u,r.addPage(),r.addImage(l,"PNG",f,m,c,u),g-=d;const w=y.currentActId;r.save(`Акт №${w}.pdf`),E("PDF успішно створено!","success",2e3)}catch(a){console.error("💥 Помилка при генерації PDF:",a),E("Помилка генерації PDF","error")}finally{y.settings.showPibMagazin=o,On(),document.body.removeChild(t)}}function On(){Mt(document.getElementById(Ge),y.settings.showPibMagazin)}function Mt(e,t){const n=e.querySelector(`#${ye} table`);if(!n)return;n.querySelectorAll('td[data-name="pib_magazin"]').forEach(a=>{t?a.removeAttribute("hidden"):a.setAttribute("hidden","true")}),n.querySelectorAll("thead th").forEach(a=>{var r;(a.getAttribute("data-name")==="pib_magazin"||((r=a.textContent)==null?void 0:r.trim())==="ПІБ _ Магазин")&&(t?a.removeAttribute("hidden"):a.setAttribute("hidden","true"))})}async function Ne(e){_n();const t=document.getElementById(Ze),n=document.getElementById(Ge);if(!t||!n){console.error("❌ Модальне вікно або його тіло не знайдені.");return}if(await zt(),!document.getElementById(Fe)){const o=yn();document.body.appendChild(o)}if(!document.getElementById(Ve)){const o=vn();document.body.appendChild(o)}y.currentActId=e,t.setAttribute("data-act-id",e.toString()),E("Завантаження даних акту...","info",2e3),n.innerHTML="",t.classList.remove("hidden");try{const{data:o,error:s}=await _.from("acts").select("*").eq("act_id",e).single();if(s||!o){E(`Помилка завантаження акту: ${(s==null?void 0:s.message)||"Перевірте підключення."}`,"error"),n.innerHTML=`<p class="error-message">❌ Не вдалося завантажити акт. ${(s==null?void 0:s.message)||"Перевірте підключення."}</p>`;return}y.isActClosed=!!o.date_off;let a={fio:"—",phone:"—",note:"—"};if(o.client_id){const{data:C}=await _.from("clients").select("data").eq("client_id",o.client_id).single(),k=C!=null&&C.data?ce(C.data):null;k&&(a={fio:k.ПІБ||k.fio||"—",phone:k.Телефон||k.phone||"—",note:k.Додаткові||"—"})}let l=null;if(o.cars_id){const{data:C}=await _.from("cars").select("data").eq("cars_id",o.cars_id).single();C&&(l=ce(C.data))}const r=ce(o.info||o.data||o.details)||{},i=(l==null?void 0:l.Авто)||"",d=(l==null?void 0:l.Рік)||"",c=(l==null?void 0:l.Vincode)||"—",u=(l==null?void 0:l.КодДВЗ)||"",f=(l==null?void 0:l.Обʼєм)||"",m=(l==null?void 0:l.Пальне)||"",g=[u,f,m].filter(Boolean).join(" _ ")||"—",w=(r==null?void 0:r.Пробіг)||"0",I=(r==null?void 0:r["Причина звернення"])||"—",x=(r==null?void 0:r.Рекомендації)||"—",N=Array.isArray(r==null?void 0:r.Фото)?r.Фото:[],T=Et(o.date_off),O=Et(o.date_on),D=y.isActClosed?"Закритий":"Відкритий",W=`
      <div class="status-row">
        <div class="status-dates">
          ${y.isActClosed?`<span class="red">${T}</span> | <span class="green">${O}</span>`:`<span class="green">${O||"-"}</span>`}
        </div>
        <button class="status-lock-icon" id="status-lock-btn" data-act-id="${e}">${y.isActClosed?"🔒":"🗝️"}</button>
      </div>
    `,ee=N.length?N.map(C=>`<div><a href="${C}" target="_blank" style="color:green; text-decoration: none">Відкрити архів фото</a></div>`).join(""):`<div><a href="#" id="${ht}" style="color:red; text-decoration: none">Створити фото Google</a></div>`,fe=(r==null?void 0:r.Деталі)||[],J=(r==null?void 0:r.Роботи)||[],te=[...fe.map(C=>({type:"detail",name:C.Деталь,quantity:C.Кількість,price:C.Ціна,sum:C.Сума,person_or_store:C.Магазин})),...J.map(C=>({type:"work",name:C.Робота,quantity:C.Кількість,price:C.Ціна,sum:C.Сума,person_or_store:C.Слюсар}))],F=Cn(te,y.settings.showPibMagazin),ne=y.isActClosed?'cursor: not-allowed;"':"",p=y.isActClosed?'contenteditable="false"':'contenteditable="true"',h=`
<div class="closed-act-info">
    <p><strong>Претензій до вартості замовлення, виконаних робіт, встановлених запчастин та використаних матеріалів не маю.</strong></p>
    <p><strong>Гарантійні зобов’язання</strong></p>
    <p>Виконавець гарантує відповідне відремонтованого ДТЗ (або його складових запчастин) вимогам технічної документації та нормативних документів виробника за умов виконання Замовником правил експлуатації ДТЗ. Гарантійний термін експлуатації на запасні частини встановлюється згідно з Законом України "Про захист прав споживачів". Гарантійні зобов'язання виконавця не розповсюджуються на запасні частини, надані Замовником. Деталі, що не були затребувані Замовником на момент видачі автомобіля, утилізуються та поверненню не підлягають. Цим підписом я надаю однозначну згоду на обробку моїх персональних даних з метою надання сервісних, гарантійних та інших супутніх послуг. Я повідомлений(на) про свої права, передбачені ст. 8 Закону України "Про захист персональних даних".</p>
    <br>
    <table>
        <tr>
            <td><strong>Замовник:</strong> З об'ємом та вартістю робіт згоден</td>
            <td><strong>Виконавець:</strong></td>
        </tr>
        <tr>
            <td><hr class="signature-line"></td>
            <td><hr class="signature-line"></td>
        </tr>
    </table>
</div>
    `;n.innerHTML=`
      <div class="zakaz_narayd-header">
        <div class="zakaz_narayd-header-info">
          <h1>San Sanych</h1>
          <p>Адрес: м.Вінниця район крива</p>
          <p>067 732 51 15 тел</p>
        </div>
      </div>

      <div class="zakaz_narayd-table-container">
        <table class="zakaz_narayd-table left">
          ${se("Акт №",`<span id="act-number">${o.act_id.toString()}</span>`)}
          ${se("Клієнт",a.fio)}
          ${se("Телефон",`<span style="color: blue;">${a.phone}</span>`)}
          ${se("Примітка:",a.note)}
          <tr>
            <td>Фото</td>
            <td id="${ht}" style="cursor: pointer;">
              ${ee}
            </td>
          </tr>
        </table>

        <table class="zakaz_narayd-table right">
          ${se(D,W)}
          ${se("Марка / рік",`${i} ${d}`.trim()||"—")}
          ${se("Vincode",c)}
          ${se("Двигун",g)}
          ${se("Пробіг",`<span id="${Re}" ${p} ${ne}>${H(w,0,0)}</span>`)}
        </table>
      </div>

<div class="reason-container">

  <!-- Причина звернення -->
  <div class="zakaz_narayd-reason-line">
    <div class="reason-text">
      <strong>Причина звернення:</strong>
      <span id="${At}" class="highlight" ${p} ${ne}>${I}</span>
    </div>
    <button id="print-act-button" title="Друк акту" class="print-button">🖨️</button>
  </div>

  <!-- Рекомендації -->
  <div class="zakaz_narayd-reason-line"> <!-- такий самий клас, як і вище -->
    <div class="recommendations-text">
      <strong>Рекомендації:</strong>
      <span id="${Bt}" class="highlight" ${p} ${ne}>${x}</span>
    </div>
    <button id="sklad" title="Склад" class="sklad">📦</button>
  </div>

</div>



      ${F}
      ${y.isActClosed?h:""} `,Hn(e);const v=document.getElementById("print-act-button"),b=document.getElementById("sklad");if(b&&b.addEventListener("click",()=>{Nn()}),v&&v.addEventListener("click",Pn),!y.isActClosed){ot(ye,y);const C=document.getElementById("add-row-button");C&&(C.addEventListener("click",()=>wn(ye)),C.addEventListener("mouseenter",()=>{C.style.backgroundColor="#45a049"}),C.addEventListener("mouseleave",()=>{C.style.backgroundColor="#4CAF50"}))}const S=document.getElementById(ye);S&&S.addEventListener("input",C=>{var pe,ge,ze;const k=C.target,oe=k.getAttribute("data-name");if(y.isActClosed){const z=window.getSelection();if(z&&z.rangeCount>0){const M=z.getRangeAt(0),A=M.startOffset,P=k.textContent||"";k.textContent=P.slice(0,A-1)+P.slice(A),M.setStart(k.firstChild||k,Math.max(0,A-1)),M.collapse(!0),z.removeAllRanges(),z.addRange(M)}E("Неможливо редагувати закритий акт","warning",1e3);return}if(oe==="price"||oe==="id_count"){let z=((pe=k.textContent)==null?void 0:pe.replace(/[^0-9]/g,""))||"";if(k.textContent!==z){const A=window.getSelection(),P=(A==null?void 0:A.focusOffset)||0;if(k.textContent=z,A&&k.firstChild){const R=Math.min(P,z.length),V=document.createRange();V.setStart(k.firstChild,R),V.collapse(!0),A.removeAllRanges(),A.addRange(V)}}const M=k.closest("tr");M&&En(M)}else if(oe==="name"){const z=((ge=k.textContent)==null?void 0:ge.trim())||"",M=k.closest("tr"),A=M==null?void 0:M.querySelector("td:first-child");let P="";if(y.details.includes(z)?P="details":y.works.includes(z)&&(P="works"),k.setAttribute("data-type",P),A){const R=[...M.parentElement.children].indexOf(M)+1;A.textContent=P==="details"?`⚙️ ${R}`:P==="works"?`🛠️ ${R}`:`${R}`}De()}else if(k.id===Re){let z=((ze=k.textContent)==null?void 0:ze.replace(/[^0-9]/g,""))||"";const M=H(z,0,0);if(k.textContent!==M){const A=window.getSelection(),P=(A==null?void 0:A.focusOffset)||0;if(k.textContent=z,A&&k.firstChild){const R=Math.min(P,z.length),V=document.createRange();V.setStart(k.firstChild,R),V.collapse(!0),A.removeAllRanges(),A.addRange(V)}if(k.textContent=M,A&&k.firstChild){const R=M.length,V=z.length,j=R-V,be=Math.min(P+j,R),B=document.createRange();B.setStart(k.firstChild,Math.max(0,be)),B.collapse(!0),A.removeAllRanges(),A.addRange(B)}}}}),pn(n,a.phone),un(y.isActClosed),Rn(e,r),gn(Re),De(),E("Дані успішно завантажено","success",1500)}catch(o){console.error("💥 Критична помилка при завантаженні акту:",o),E(`Критична помилка завантаження акту: ${o instanceof Error?o.message:"Невідома помилка"}`,"error"),n.innerHTML='<p class="error-message">❌ Критична помислова завантаження акту. Перегляньте консоль.</p>'}}function Hn(e){const t=document.getElementById("status-lock-btn");t&&t.addEventListener("click",async n=>{if(n.preventDefault(),n.stopPropagation(),y.isActClosed){if(E("Акт закрито. Для відкриття введіть пароль.","info",2e3),await bn())try{E("Відкриття акту...","info");const{error:a}=await _.from("acts").update({date_off:null}).eq("act_id",e);if(a){E("Помилка відкриття акту: "+a.message,"error");return}y.isActClosed=!1,E("Акт успішно відкрито","success",2e3),setTimeout(()=>{Ne(e)},500),tt()}catch(a){console.error("Помилка при відкритті акту:",a),E("Критична помилка при відкритті акту","error")}else E("Операцію відмінено або пароль невірний.","warning",1500);return}if(await hn(e))try{E("Закриття акту...","info");const{error:s}=await _.from("acts").update({date_off:qn(new Date)}).eq("act_id",e);if(s){E("Помилка закриття акту: "+s.message,"error");return}y.isActClosed=!0,E("Акт успішно закрито","success",2e3),setTimeout(()=>{Ne(e)},500),tt()}catch(s){console.error("Помилка при закритті акту:",s),E("Критична помилка при закритті акту","error")}})}function Rn(e,t){var o;const n=document.getElementById(xt);if(n){const s=n.cloneNode(!0);(o=n.parentNode)==null||o.replaceChild(s,n),s.addEventListener("click",async()=>{var I,x,N,T,O;if(y.isActClosed){E("Неможливо редагувати закритий акт","warning");return}const a=document.getElementById(Re),l=((I=a==null?void 0:a.textContent)==null?void 0:I.trim().replace(/\s/g,""))||"",r=((N=(x=document.getElementById(At))==null?void 0:x.textContent)==null?void 0:N.trim())||"",i=((O=(T=document.getElementById(Bt))==null?void 0:T.textContent)==null?void 0:O.trim())||"",d=document.querySelectorAll(`#${ye} tbody tr`),c=[],u=[];let f=0,m=0;d.forEach(D=>{var C,k,oe,pe,ge;const W=D.querySelector('[data-name="name"]'),ee=D.querySelector('[data-name="id_count"]'),fe=D.querySelector('[data-name="price"]'),J=D.querySelector('[data-name="sum"]'),te=y.settings.showPibMagazin?D.querySelector('[data-name="pib_magazin"]'):null,F=((C=W==null?void 0:W.textContent)==null?void 0:C.trim())||"",ne=parseFloat(((k=ee==null?void 0:ee.textContent)==null?void 0:k.replace(/\s/g,"").replace(",","."))||"0"),p=parseFloat(((oe=fe==null?void 0:fe.textContent)==null?void 0:oe.replace(/\s/g,"").replace(",","."))||"0"),h=parseFloat(((pe=J==null?void 0:J.textContent)==null?void 0:pe.replace(/\s/g,"").replace(",","."))||"0"),v=((ge=te==null?void 0:te.textContent)==null?void 0:ge.trim())||"";if(!F&&ne===0&&p===0&&h===0&&!v)return;const b={Кількість:ne,Ціна:p,Сума:h},S=W.getAttribute("data-type");S==="details"||y.details.includes(F)?(c.push({...b,Деталь:F,Магазин:v}),f+=h):S==="works"||y.works.includes(F)?(u.push({...b,Робота:F,Слюсар:v}),m+=h):(c.push({...b,Деталь:F,Магазин:v}),f+=h)});const g=f+m,w={...t||{},Пробіг:l,"Причина звернення":r,Рекомендації:i,Деталі:c,Роботи:u,"За деталі":f,"За роботу":m,"Загальна сума":g};try{E("Збереження змін...","info");const{error:D}=await _.from("acts").update({data:w}).eq("act_id",e);if(D){E("Помилка збереження: "+D.message,"error");return}E("Зміни успішно збережено","success"),De(),tt()}catch(D){E("Помилка збереження даних","error"),console.error("Помилка збереження:",D)}})}}document.addEventListener("other-base-data-updated",async()=>{try{await zt(),ot(ye,y)}catch(e){console.error("Помилка оновлення даних:",e),E("Помилка при оновленні даних","error")}});const Qe=["№ акту","Дата","Клієнт 🔽","Автомобіль","Сумма"];let Be=[],rt=[],lt=[],Ue=0;function it(e){if(typeof e=="string")try{return JSON.parse(e)}catch{return null}return e}function wt(e){return`${e.getDate().toString().padStart(2,"0")}.${(e.getMonth()+1).toString().padStart(2,"0")}.${e.getFullYear()}`}function Ct(e){if(!/^\d{2}\.\d{2}\.\d{4}$/.test(e))return!1;const[n,o,s]=e.split("."),a=parseInt(n),l=parseInt(o),r=parseInt(s);return a>=1&&a<=31&&l>=1&&l<=12&&r>=2e3&&r<=2100}function Tt(e,t){const n=t==null?void 0:t.find(l=>l.client_id===e.client_id),o=it(n==null?void 0:n.data),s=(o==null?void 0:o.ПІБ)||"Невідомо";let a=(o==null?void 0:o.Телефон)||"";return a=a.replace(/[\(\)\-\s]/g,""),a?`${s} ${a}`:s}function Dt(e,t){const n=t==null?void 0:t.find(l=>l.cars_id===e.cars_id),o=it(n==null?void 0:n.data),s=(o==null?void 0:o["Номер авто"])||"",a=(o==null?void 0:o.Авто)||"";return`${s} ${a}`.trim()}function Fn(e){const t=it(e.info||e.data||e.details),n=(t==null?void 0:t["Загальна сума"])||(t==null?void 0:t.total)||(t==null?void 0:t.amount)||e.total||e.amount;if(n===void 0)return"0 грн";const o=Number(n);return isNaN(o)?"0 грн":`${o.toLocaleString("uk-UA")} грн`}function Vn(e){if(!e.date_on)return"-";const t=new Date(e.date_on),n=t.getDate().toString().padStart(2,"0"),o=(t.getMonth()+1).toString().padStart(2,"0"),s=t.getFullYear(),a=t.getHours().toString().padStart(2,"0"),l=t.getMinutes().toString().padStart(2,"0");return`<div class="phone-blue-italic">${a}:${l}</div><div>${n}.${o}.${s}</div>`}function et(e){return e.date_off&&!isNaN(Date.parse(e.date_off))}function Yn(e,t){const n=document.createElement("td"),o=[...e.matchAll(/\+380\d{9,}/g)].map(a=>a[0]);let s=e;return o.forEach(a=>{s=s.replace(a,"").trim()}),n.innerHTML=`<div>${s}</div>`,o.forEach(a=>{n.innerHTML+=`<div class="phone-blue-italic">${a}</div>`}),n.addEventListener("click",()=>Ne(t)),n}function Gn(e,t){const n=document.createElement("td"),o=e.split(" "),s=o[0]||"",a=o.slice(1).join(" ")||"";return n.innerHTML=`<div>${s}</div>${a?`<div><span class="car-red-bold">${a}</span></div>`:""}`,n.addEventListener("dblclick",()=>Ne(t)),n}function Wn(e,t){const n=document.createElement("td");return n.innerHTML=e,n.addEventListener("dblclick",()=>Ne(t)),n}function Nt(e,t,n,o){o.innerHTML="",e.forEach(s=>{var d;const a=et(s),r=[`${a?"🔒":"🗝️"} ${((d=s.act_id)==null?void 0:d.toString())||"N/A"}`,Vn(s),Tt(s,t),Dt(s,n),Fn(s)],i=document.createElement("tr");i.classList.add(a?"row-closed":"row-open"),r.forEach((c,u)=>{let f;Qe[u].includes("Клієнт")?f=Yn(c,s.act_id):Qe[u]==="Автомобіль"?f=Gn(c,s.act_id):f=Wn(c,s.act_id),i.appendChild(f)}),o.appendChild(i)})}function Un(){Ue===0?(Be.sort((e,t)=>{const n=!et(e),o=!et(t);return n&&!o?-1:!n&&o?1:0}),Ue=1):(Be.sort((e,t)=>new Date(t.date_on).getTime()-new Date(e.date_on).getTime()),Ue=0)}function qt(){const e=new Date,t=new Date(e.getFullYear(),e.getMonth()-1,e.getDate());return`${wt(t)} - ${wt(e)}`}function ct(){var a;const e=document.getElementById("dateRangePicker");((a=e==null?void 0:e.value)==null?void 0:a.trim())||(console.warn("⚠️ Діапазон дат порожній. Завантажуємо всі акти за останній місяць."),e.value=qt());const n=e.value.trim();if(n==="Відкриті")return null;if(!n.includes(" - "))return console.error("❌ Невірний формат діапазону. Очікується: DD.MM.YYYY - DD.MM.YYYY"),null;const[o,s]=n.split(" - ");if(!Ct(o)||!Ct(s))return console.error("❌ Невірний формат дати. Використовуйте DD.MM.YYYY"),null;try{const[l,r]=[o,s].map((i,d)=>{const[c,u,f]=i.split("."),m=`${f}-${u.padStart(2,"0")}-${c.padStart(2,"0")}`;return d===0?`${m} 00:00:00`:`${m} 23:59:59`});return{dateFrom:l,dateTo:r}}catch(l){return console.error("❌ Помилка конвертації дати:",l),null}}async function Xn(e,t,n=null){let o=_.from("acts").select("*");if(n==="open")o=o.is("date_off",null);else if(e&&t)o=o.gte("date_on",e).lte("date_on",t);else{console.warn("⚠️ loadActsFromDB викликано без фільтрів. Завантажуємо акти за останній місяць.");const l=ct();if(l)o=_.from("acts").select("*").gte("date_on",l.dateFrom).lte("date_on",l.dateTo);else return[]}o=o.order("act_id",{ascending:!1});const{data:s,error:a}=await o;return a?(console.error("❌ Помилка при отриманні актів:",a),null):s||[]}async function Jn(){const{data:e,error:t}=await _.from("clients").select("client_id, data");return t?(console.error("❌ Помилка при отриманні клієнтів:",t),null):e||[]}async function jn(){const{data:e,error:t}=await _.from("cars").select("cars_id, data");return t?(console.error("❌ Помилка при отриманні авто:",t),null):e||[]}function Zn(){const e=document.createElement("thead"),t=document.createElement("tr");return Qe.forEach(n=>{const o=document.createElement("th");o.textContent=n,o.addEventListener("click",()=>{n==="Клієнт 🔽"&&(Un(),Kn())}),t.appendChild(o)}),e.appendChild(t),e}function Kn(){const e=document.querySelector("#table-container-modal-sakaz_narad table");if(!e)return;const t=document.createElement("tbody");Nt(Be,rt,lt,t);const n=e.querySelector("tbody");n&&n.replaceWith(t)}function Qn(){const e=document.createElement("table");e.style.width="100%",e.style.borderCollapse="collapse";const t=Zn(),n=document.createElement("tbody");return Nt(Be,rt,lt,n),e.appendChild(t),e.appendChild(n),e}function eo(e){const t=document.getElementById("table-container-modal-sakaz_narad");t&&(t.innerHTML=`<div style="text-align: center; padding: 20px; color: #666;">
      ${e}
    </div>`)}async function K(e,t,n,o){try{let s=null,a=null,l=n||null;const r=o?o.toLowerCase():null;if(l!=="open")if(e&&t)s=e,a=t;else{const g=ct();if(g)s=g.dateFrom,a=g.dateTo;else if($("#dateRangePicker").val()==="Відкриті")l="open";else{const w=qt(),[I,x]=w.split(" - "),[N,T,O]=I.split("."),[D,W,ee]=x.split(".");s=`${O}-${T.padStart(2,"0")}-${N.padStart(2,"0")} 00:00:00`,a=`${ee}-${W.padStart(2,"0")}-${D.padStart(2,"0")} 23:59:59`,$("#dateRangePicker").val(w)}}const[i,d,c]=await Promise.all([Xn(s,a,l),Jn(),jn()]);if(i===null||d===null||c===null)return;rt=d,lt=c;let u=i;if(r&&(u=i.filter(g=>{const w=Tt(g,d),I=Dt(g,c);return w.toLowerCase().includes(r)||I.toLowerCase().includes(r)})),Be=u,Be.length===0){console.warn("⚠️ Немає актів у вказаному діапазоні дат або за терміном пошуку.");let g="Немає актів";if(l==="open")g+=" (відкритих)";else{const w=document.getElementById("dateRangePicker");g+=` у діапазоні дат: ${(w==null?void 0:w.value)||"невідомий"}`}r&&(g+=` за запитом "${o}"`),eo(g);return}const f=Qn(),m=document.getElementById("table-container-modal-sakaz_narad");m?(m.innerHTML="",m.appendChild(f)):console.error("❌ Контейнер table-container-modal-sakaz_narad не знайдено.")}catch(s){console.error("💥 Критична помилка:",s)}}function tt(){var r;const e=document.getElementById("searchInput"),t=((r=e==null?void 0:e.value)==null?void 0:r.trim())||"",o=document.getElementById("dateRangePicker").value.trim();let s=null,a=null,l=null;if(o==="Відкриті")s="open";else{const i=ct();i&&(a=i.dateFrom,l=i.dateTo)}K(a,l,s,t)}function to(){const e=document.getElementById("dateRangePicker");if(!e)return;let t=e.value;const n=new MutationObserver(()=>{var s;const o=e.value;if(o!==t){t=o;const a=document.getElementById("searchInput"),l=((s=a==null?void 0:a.value)==null?void 0:s.trim())||"";K(void 0,void 0,void 0,l)}});n.observe(e,{attributes:!0,childList:!0,characterData:!0,subtree:!0}),window.addEventListener("beforeunload",()=>{n.disconnect()})}function no(){K(),to()}_.auth.getSession().then(({data:{session:e}})=>{e?no():console.warn("⛔ Користувач не авторизований. Таблиця не завантажена.")});const Pe="save-prompt-modal";function Pt(){const e=document.createElement("div");e.id=Pe,e.className="modal-overlay-save",e.style.display="none";const t=document.createElement("div");return t.className="modal-content-save",t.innerHTML=`
    <p>Зберегти зміни?</p>
    <div class="save-buttons">
      <button id="save-confirm" class="btn-save-confirm">Так</button>
      <button id="save-cancel" class="btn-save-cancel">Ні</button>
    </div>
  `,e.appendChild(t),e}function Ot(){return new Promise(e=>{const t=document.getElementById(Pe);if(!t)return e(!1);t.style.display="flex";const n=document.getElementById("save-confirm"),o=document.getElementById("save-cancel"),s=()=>{t.style.display="none",n.removeEventListener("click",l),o.removeEventListener("click",r)},a=(i,d)=>{const c=document.createElement("div");c.textContent=i,c.style.position="fixed",c.style.bottom="50%",c.style.left="50%",c.style.transform="translateX(-50%)",c.style.backgroundColor=d,c.style.color="white",c.style.padding="12px 24px",c.style.borderRadius="8px",c.style.zIndex="10001",c.style.boxShadow="0 4px 12px rgba(0,0,0,0.2)",c.style.fontSize="16px",document.body.appendChild(c),setTimeout(()=>c.remove(),2500)},l=()=>{s(),a("✅ Дані успішно збережено","#4caf50"),e(!0)},r=()=>{s(),a("✖ Скасовано користувачем","#f44336"),e(!1)};n.addEventListener("click",l),o.addEventListener("click",r)})}async function oo(e){const{error:t}=await _.from("cars").delete().eq("cars_id",e);t?console.error("❌ Помилка видалення автомобіля:",t.message):console.log("✅ Автомобіль успішно видалений")}async function kt(e,t){const{error:n}=await _.from("cars").insert({client_id:e,data:{Авто:t.carModel,"Номер авто":t.carNumber,Обʼєм:t.engine,Пальне:t.fuel,Vincode:t.vin,Рік:t.year,КодДВЗ:t.carCode}});n?console.error("❌ Помилка додавання автомобіля:",n.message):console.log("✅ Автомобіль успішно додано")}async function Xe(){const e=Ht();if(!e.fullName||!e.phone){console.error("❌ Обов'язкові поля (ПІБ, Телефон) не заповнені");return}if(X==="no"&&e.cars_id){await oo(e.cars_id);return}if(X==="yes"&&e.client_id){await kt(e.client_id,e);return}if(X==="yes"&&!e.client_id){const{data:t,error:n}=await _.from("clients").insert({data:{ПІБ:e.fullName,Телефон:e.phone,Джерело:e.income,Додаткові:e.extra}}).select("client_id").single();if(n||!(t!=null&&t.client_id)){console.error("❌ Не вдалося створити клієнта:",n==null?void 0:n.message);return}await kt(t.client_id,e);return}if(X===null&&e.client_id){const{error:t}=await _.from("clients").update({data:{ПІБ:e.fullName,Телефон:e.phone,Джерело:e.income,Додаткові:e.extra}}).eq("client_id",e.client_id);if(t?console.error("❌ Помилка оновлення клієнта:",t.message):console.log("✅ Клієнт оновлений"),e.cars_id){const{error:n}=await _.from("cars").update({data:{Авто:e.carModel,"Номер авто":e.carNumber,Обʼєм:e.engine,Пальне:e.fuel,Vincode:e.vin,Рік:e.year,КодДВЗ:e.carCode}}).eq("cars_id",e.cars_id);n?console.error("❌ Помилка оновлення авто:",n.message):console.log("✅ Авто оновлено")}return}console.warn("⚠️ Незрозумілий стан або не вистачає ID. Дані не збережено.")}function dt(e){const t=e.replace(/\D/g,"");if(t.startsWith("380")){const n=t.slice(3);return n.length===0?"+380":n.length<=2?`+380(${n}`:n.length<=5?`+380(${n.slice(0,2)})${n.slice(2)}`:n.length<=7?`+380(${n.slice(0,2)})${n.slice(2,5)}-${n.slice(5)}`:`+380(${n.slice(0,2)})${n.slice(2,5)}-${n.slice(5,7)}-${n.slice(7,9)}`}return t.length===0?"+380":t.length<=2?`+380(${t}`:t.length<=5?`+380(${t.slice(0,2)})${t.slice(2)}`:t.length<=7?`+380(${t.slice(0,2)})${t.slice(2,5)}-${t.slice(5)}`:`+380(${t.slice(0,2)})${t.slice(2,5)}-${t.slice(5,7)}-${t.slice(7,9)}`}function Ht(){const e=n=>{var o;return((o=document.getElementById(n))==null?void 0:o.value)||""},t=e(we);return{client_id:re,cars_id:le,fullName:e(qe),phone:t,carModel:e(Ee),carCode:e(me),carNumber:e(Ce),engine:e(de),fuel:e(ie),vin:e(ue),income:e(Z),extra:e(ve),year:e(ke)}}function It(){re=null,le=null,X=null;const e=document.getElementById(Pe);e&&e.classList.remove("active")}const Me="custom-modal-create-sakaz_narad",ao="modal-content-create-sakaz_narad",Rt="close-create-sakaz_narad",ut="btn-edit-create-sakaz_narad",qe="client-input-create-sakaz_narad",Ft="client-list-create-sakaz_narad",Ee="car-model-create-sakaz_narad",mt="car-model-list-create-sakaz_narad",we="phone-create-sakaz_narad",ft="phone-list-create-sakaz_narad",Ce="car-number-input-create-sakaz_narad",pt="car-number-list-create-sakaz_narad",de="car-engine-create-sakaz_narad",Vt="car-engine-list-create-sakaz_narad",ie="car-fuel-create-sakaz_narad",ue="car-vin-create-sakaz_narad",Yt="car-vin-list-create-sakaz_narad",Z="car-income-create-sakaz_narad",ve="extra-create-sakaz_narad",Gt="btn-save-create-sakaz_narad",ke="car-year-create-sakaz_narad",me="car-code-create-sakaz_narad",Wt="car-code-list-create-sakaz_narad",Ut="btn-create-create-sakaz_narad";let re=null,le=null,Ae={},X=null,Y={carModels:[],carCodes:[],phones:[],carNumbers:[],engines:[],vins:[]};function so(){const e=document.getElementById(ut);return(e==null?void 0:e.getAttribute("data-unlocked"))!=="true"}function ro(){const e=document.createElement("div");e.id=Me,e.className="modal-overlay-create-sakaz_narad";const t=document.createElement("div");return t.className=ao,t.innerHTML=`
    <button id="${Rt}" class="modal-close-create-sakaz_narad">&times;</button>
    <div class="modal-header-create-sakaz_narad">
      <h2>🔍 Картка клієнта</h2>
    </div>
    ${lo()}
    <div class="buttons-create-sakaz_narad">
      <button id="${ut}" class="btn-action-create-sakaz_narad btn-edit" title="Заблокувати інші поля">🔒</button>
      <button id="${Gt}" class="btn-action-create-sakaz_narad btn-save" title="Зберегти">💾</button>    
      <button id="${Ut}" class="btn-action-create-sakaz_narad btn-create" title="Створити">📝</button>
      </div>
  `,e.appendChild(t),e}function lo(){return`
    <div class="field-create-sakaz_narad">
      <label for="${qe}">ПІБ</label>
      <input type="text" id="${qe}" class="input-create-sakaz_narad" placeholder="Введіть ПІБ" autocomplete="off" />
      <ul id="${Ft}" class="suggestions-list-create-sakaz_narad"></ul>
    </div>

    <div class="field-create-sakaz_narad">
      <label for="${we}">Номер телефону</label>
      <div class="phone-field-inline">
        <input type="text" id="${we}" class="input-create-sakaz_narad" placeholder="+380(XX)XXX-XX-XX" autocomplete="off" />
        <div id="car-confirm-icons" class="car-confirm-icons">
          <button id="confirm-toggle" class="confirm-button yes" title="Підтвердження">✔️</button>
        </div>
      </div>
      <ul id="${ft}" class="suggestions-list-create-sakaz_narad"></ul>
    </div>

    <div class="car-field-inline">
      <div class="field-create-sakaz_narad car-input-group">
        <label for="${Ee}">Автомобіль</label>
        <input type="text" id="${Ee}" class="input-create-sakaz_narad" placeholder="Автомобіль" />
        <ul id="${mt}" class="suggestions-list-create-sakaz_narad"></ul>
      </div>

      <div class="field-create-sakaz_narad car-code-input-group">
        <label for="${Ce}">Номер авто</label>
        <input type="text" id="${Ce}" class="input-create-sakaz_narad" placeholder="Номер авто" autocomplete="off" />
        <ul id="${pt}" class="suggestions-list-create-sakaz_narad"></ul>
      </div>

      <div class="field-create-sakaz_narad year-input-group">
        <label for="${ke}">Рік</label>
        <input type="text" id="${ke}" class="input-create-sakaz_narad" readonly />
      </div>
    </div>

    <div class="field-row-create-sakaz_narad">
      <div class="field-create-sakaz_narad">
        <label for="${de}">Обʼєм</label>
        <input type="text" id="${de}" class="input-create-sakaz_narad" readonly />
        <ul id="${Vt}" class="suggestions-list-create-sakaz_narad"></ul>
      </div>

      <div class="field-create-sakaz_narad car-code-input-group">
        <label for="${me}">Код ДВЗ</label>
        <input type="text" id="${me}" class="input-create-sakaz_narad" readonly />
        <ul id="${Wt}" class="suggestions-list-create-sakaz_narad"></ul>
      </div>

      <div class="field-create-sakaz_narad">
        <label for="${ie}">Пальне</label>
        <input type="text" id="${ie}" class="input-create-sakaz_narad" readonly />
      </div>
    </div>

    <div class="field-row-create-sakaz_narad">
      <div class="field-create-sakaz_narad">
        <label for="${ue}">VIN-код</label>
        <input type="text" id="${ue}" class="input-create-sakaz_narad" readonly />
        <ul id="${Yt}" class="suggestions-list-create-sakaz_narad"></ul>
      </div>

      <div class="field-create-sakaz_narad">
        <label for="${Z}">Джерело</label>
        <input type="text" id="${Z}" class="input-create-sakaz_narad" readonly />
      </div>
    </div>

    <div class="field-create-sakaz_narad">
      <label for="${ve}">Додатково</label>
      <input type="text" id="${ve}" class="input-create-sakaz_narad" readonly />
    </div>
  `}function io(e){e.value||(e.value="+380"),e.addEventListener("input",t=>{const n=t.target,o=n.selectionStart||0,s=n.value,a=dt(n.value);n.value=a;const l=a.length-s.length,r=o+l;setTimeout(()=>{n.setSelectionRange(r,r)},0)}),e.addEventListener("focus",()=>{e.value==="+380"&&setTimeout(()=>{e.setSelectionRange(e.value.length,e.value.length)},0)}),e.addEventListener("keydown",t=>{const o=t.target.selectionStart||0;if((t.key==="Backspace"||t.key==="Delete")&&o<=4){t.preventDefault();return}})}function Le(e,t,n,o,s,a=!1,l){if(l&&Ae[l]){const f=Ae[l];e.removeEventListener("input",f.inputHandler),e.removeEventListener("focus",f.focusHandler),e.removeEventListener("blur",f.blurHandler)}const r=()=>c(),i=()=>{a?u():c()},d=()=>setTimeout(()=>t.innerHTML="",150);e.addEventListener("input",r),e.addEventListener("focus",i),e.addEventListener("blur",d),l&&(Ae[l]={inputHandler:r,focusHandler:i,blurHandler:d});function c(){t.innerHTML="";const f=e.value.toLowerCase();if(f.length===0&&!a)return;n.filter(g=>o(g).toLowerCase().includes(f)).slice(0,10).forEach(g=>{const w=document.createElement("li");w.textContent=o(g),w.addEventListener("click",()=>{e.value=o(g),t.innerHTML="",s(g)}),t.appendChild(w)})}function u(){t.innerHTML="",n.slice(0,10).forEach(f=>{const m=document.createElement("li");m.textContent=o(f),m.addEventListener("click",()=>{e.value=o(f),t.innerHTML="",s(f)}),t.appendChild(m)})}}function Se(e,t,n,o,s){Le(e,t,n,a=>a,a=>{},!0,s)}function Je(e){document.getElementById(de).value=e.Обʼєм||"",document.getElementById(ie).value=e.Пальне||"",document.getElementById(ue).value=e.Vincode||"",document.getElementById(Ce).value=e["Номер авто"]||"",document.getElementById(Ee).value=e.Авто||"",document.getElementById(ke).value=e.Рік||"",document.getElementById(me).value=e.КодДВЗ||e["Код ДВЗ"]||""}async function Xt(e){const{data:t}=await _.from("clients").select("data").eq("client_id",e).single();return(t==null?void 0:t.data)||null}async function $t(e){const t=await Xt(e);if(t){document.getElementById(qe).value=t.ПІБ||"";const n=document.getElementById(we),o=t.Телефон||"";return o&&(n.value=dt(o)),document.getElementById(ve).value=t.Додаткові||"",document.getElementById(Z).value=t.Джерело||"Не вказано",t}return null}async function co(){const{data:e}=await _.from("cars").select("data"),{data:t}=await _.from("clients").select("data");if(e){const n=[...new Set(e.map(r=>{var i;return(i=r.data)==null?void 0:i.Авто}).filter(r=>r&&typeof r=="string"&&r.trim()).map(r=>r.toString().trim()))].sort(),o=[...new Set(e.map(r=>{var i;return(i=r.data)==null?void 0:i.КодДВЗ}).filter(r=>r&&typeof r=="string"&&r.trim()).map(r=>r.toString().trim()))].sort(),s=[...new Set(e.map(r=>{var i;return(i=r.data)==null?void 0:i["Номер авто"]}).filter(r=>r&&typeof r=="string"&&r.trim()).map(r=>r.toString().trim()))].sort(),a=[...new Set(e.map(r=>{var i;return(i=r.data)==null?void 0:i.Обʼєм}).filter(r=>r&&typeof r=="string"&&r.trim()).map(r=>r.toString().trim()))].sort(),l=[...new Set(e.map(r=>{var i;return(i=r.data)==null?void 0:i.Vincode}).filter(r=>r&&typeof r=="string"&&r.trim()).map(r=>r.toString().trim()))].sort();Y.carModels=n,Y.carCodes=o,Y.carNumbers=s,Y.engines=a,Y.vins=l}if(t){const n=[...new Set(t.map(o=>{var s;return(s=o.data)==null?void 0:s.Телефон}).filter(o=>typeof o=="string"&&!!o).flatMap(o=>o.split(/[,;]/).map(s=>s.trim()).filter(s=>s.length>0)).map(o=>dt(o)))].sort();Y.phones=n}}function uo(){const e=document.getElementById(Ee),t=document.getElementById(mt),n=document.getElementById(me),o=document.getElementById(Wt),s=document.getElementById(we),a=document.getElementById(ft),l=document.getElementById(Ce),r=document.getElementById(pt),i=document.getElementById(de),d=document.getElementById(Vt),c=document.getElementById(ue),u=document.getElementById(Yt);Se(e,t,Y.carModels,void 0,"carModelEdit"),Se(n,o,Y.carCodes,void 0,"carCodeEdit"),Se(s,a,Y.phones,void 0,"phoneEdit"),Se(l,r,Y.carNumbers,void 0,"carNumberEdit"),Se(i,d,Y.engines,void 0,"carEngineEdit"),Se(c,u,Y.vins,void 0,"carVinEdit"),document.getElementById("car-confirm-icons").style.display="flex"}async function mo(){if(document.getElementById(Pe)||document.body.appendChild(Pt()),document.getElementById(Me))return;const e=ro();document.body.appendChild(e),X="yes";const t=document.getElementById("confirm-toggle");if(document.getElementById("car-confirm-icons").style.display="none",X=null,t){const p=[{value:null,icon:"🔁",class:"",title:"Очікування підтвердження"},{value:"yes",icon:"➕",class:"yes",title:"Підтвердити"},{value:"no",icon:"❌",class:"no",title:"Відхилити"}];let h=0;const v=b=>{const S=p[b];X=S.value,t.textContent=S.icon,t.className=`confirm-button ${S.class}`,t.title=S.title,X===null&&(re=null,le=null)};v(h),t.addEventListener("click",()=>{h=(h+1)%p.length,v(h)})}await co();const n=document.getElementById(Gt),o=document.getElementById(Me),s=document.getElementById(Rt),a=document.getElementById(ut),l=document.getElementById(qe),r=document.getElementById(Ft),i=document.getElementById(Ce),d=document.getElementById(pt),c=document.getElementById(Ee),u=document.getElementById(mt),f=document.getElementById(Z),m=document.getElementById(we),g=document.getElementById(ft),w=document.getElementById(ve);io(m),[l,c,i,m].forEach(p=>p.removeAttribute("readonly")),a.addEventListener("click",async()=>{var C,k,oe,pe,ge,ze,z,M,A,P,R,V;const p=a.dataset.unlocked==="true";a.dataset.unlocked=(!p).toString(),a.textContent=p?"🔒":"🔓",a.title=p?"Розблокувати поля?":"Заблокувати поля?",p?(a.style.backgroundColor="",a.style.color=""):(a.style.backgroundColor="red",a.style.color="white");const h=(C=document.getElementById(ie))==null?void 0:C.parentElement,v=document.getElementById(ie),b=(k=document.getElementById(Z))==null?void 0:k.parentElement,S=document.getElementById(Z);if(!(!h||!v||!b||!S))if(p){const j=document.getElementById("car-confirm-icons");if(j&&(j.style.display="none"),(M=document.getElementById(de))==null||M.setAttribute("readonly","true"),(A=document.getElementById(ue))==null||A.setAttribute("readonly","true"),(P=document.getElementById(ve))==null||P.setAttribute("readonly","true"),(R=document.getElementById(ke))==null||R.setAttribute("readonly","true"),(V=document.getElementById(me))==null||V.setAttribute("readonly","true"),["carModelEdit","phoneEdit","carNumberEdit","carEngineEdit","carVinEdit","carCodeEdit"].forEach(B=>{if(Ae[B]){const L=Ae[B];let q=null;B.includes("carModel")?q=c:B.includes("phone")?q=m:B.includes("carNumber")?q=i:B.includes("carEngine")?q=document.getElementById(de):B.includes("carVin")?q=document.getElementById(ue):B.includes("carCode")&&(q=document.getElementById(me)),q&&L&&(q.removeEventListener("input",L.inputHandler),q.removeEventListener("focus",L.focusHandler),q.removeEventListener("blur",L.blurHandler))}}),Ae={},v instanceof HTMLSelectElement){const B=v.value,L=document.createElement("input");L.id=ie,L.className="input-create-sakaz_narad",L.type="text",L.readOnly=!0,L.value=B,h.replaceChild(L,v)}if(S instanceof HTMLSelectElement){const B=S.value,L=document.createElement("input");L.id=Z,L.className="input-create-sakaz_narad",L.type="text",L.readOnly=!0,L.value=B,b.replaceChild(L,S)}re=null,le=null,X=null,ne()}else{if((oe=document.getElementById(de))==null||oe.removeAttribute("readonly"),(pe=document.getElementById(ue))==null||pe.removeAttribute("readonly"),(ge=document.getElementById(ve))==null||ge.removeAttribute("readonly"),(ze=document.getElementById(ke))==null||ze.removeAttribute("readonly"),(z=document.getElementById(me))==null||z.removeAttribute("readonly"),uo(),!(v instanceof HTMLSelectElement)){const j=v.value,be=["Бензин","Дизель","Газ","Гібрид","Електро"],B=document.createElement("select"),L=document.createElement("option");L.value="Невказано",L.textContent="Невказано",B.id=ie,B.className="input-create-sakaz_narad",be.forEach(q=>{const Ie=document.createElement("option");Ie.value=q,Ie.textContent=q,B.appendChild(Ie)}),B.value=j,h.replaceChild(B,v)}if(!(S instanceof HTMLSelectElement))try{const{data:j,error:be}=await _.from("incomes").select("data");if(be){console.error("❌ Помилка при запиті до income:",be.message);return}const B=[...new Set(j.map(ae=>{var $e;return($e=ae==null?void 0:ae.data)==null?void 0:$e.Name}).filter(ae=>typeof ae=="string"&&ae.trim()!==""))],L=document.createElement("select");L.id=Z,L.className="input-create-sakaz_narad";const q=document.createElement("option");q.value="Невказано",q.textContent="Невказано",L.appendChild(q),B.forEach(ae=>{const $e=document.createElement("option");$e.value=ae,$e.textContent=ae,L.appendChild($e)});const Ie=S.value.trim();B.includes(Ie)&&(L.value=Ie),b.replaceChild(L,S)}catch(j){console.error("💥 Виняток при завантаженні джерел:",j)}}}),s.addEventListener("click",()=>o.remove());const{data:x}=await _.from("clients").select("client_id, data"),N=(x==null?void 0:x.map(p=>{var h,v;return{id:p.client_id,fullName:((h=p.data)==null?void 0:h.ПІБ)||"",phone:((v=p.data)==null?void 0:v.Телефон)||"",data:p.data||{}}}).filter(p=>p.fullName).sort((p,h)=>p.fullName.localeCompare(h.fullName)))||[],{data:T}=await _.from("cars").select("cars_id, client_id, data"),O=(T==null?void 0:T.map(p=>({...p.data||{},id:p.cars_id,client_id:p.client_id})).filter(p=>p["Номер авто"]||p.Авто).sort((p,h)=>(p.Авто||"").toString().localeCompare((h.Авто||"").toString())))||[],D=p=>O.filter(h=>h.client_id===p),W=p=>{const h=N.find(S=>S.id===p);if(!h||!h.data||!h.data.Телефон)return[];const v=h.data.Телефон;return typeof v!="string"?[]:v.split(/[,;]/).map(S=>S.trim()).filter(S=>S).map(S=>({...h,phone:S,displayPhone:S}))};function ee(){const p=l.value.trim(),h=c.value.trim();if(p===""||h===""){const v=[];return p===""&&v.push("ПІБ"),h===""&&v.push("Автомобіль"),St(!1,`❌ Заповніть поле: ${v.join(" та ")}`),!1}return!0}n.addEventListener("click",async()=>{var v,b;if(!(a.dataset.unlocked==="true")){St(!1,"🔓 Спочатку розблокуйте форму для редагування");return}!ee()||!await Ot()||(await Xe(),await K(),(v=document.getElementById(Me))==null||v.remove(),It(),console.log("📋 Дані з форми:",Ht()),await Xe(),await K(),await Xe(),await K(),(b=document.getElementById(Me))==null||b.remove(),It())});const fe=document.getElementById(Ut);fe&&fe.addEventListener("click",async()=>{const p=await Qt(()=>import("./pidtverdutu_sberihannya_zakaz_naryad-CvddQjkZ.js"),__vite__mapDeps([0,1,2,3,4])),{saveModalIdCreate:h,createSaveModalCreate:v,showSaveModalCreate:b}=p;document.getElementById(h)||document.body.appendChild(v()),await b()});const J=(p,h)=>{Le(i,d,h?[h]:p,b=>b["Номер авто"]||"",F,!0,"carNumber"),Le(c,u,p,b=>(b.Авто||"").toString().trim(),b=>{F(b),Le(i,d,[b],S=>S["Номер авто"]||"",F,!0,"carNumber")},!0,"carModel")},te=p=>{Le(m,g,p,h=>h.displayPhone||h.phone||"",async h=>{await $t(h.id),re=h.id;const v=D(h.id);let b=null;v.length>0&&(b=v[0],Je(b),le=b.id),J(v,b)},!0,"phone")},F=async p=>{Je(p);const h=await Xt(p.client_id);if(h){l.value=h.ПІБ||"",m.value=h.Телефон||"",w.value=h.Додаткові||"",f.value=h.Джерело||"",so()?(p.id&&(le=p.id),p.client_id&&(re=p.client_id)):console.log("🔓 Замок відкритий — ID не збережено");const v=D(p.client_id),b=W(p.client_id);J(v,p),te(b)}};re=null,le=null,X=null;const ne=()=>{Le(l,r,N,p=>p.fullName||"",async p=>{if(fo(),a.dataset.unlocked==="true"){l.value=p.fullName,console.log("🔓 Відкрито: дані не підтягуються автоматично");return}await $t(p.id),re=p.id;const v=D(p.id);let b=null;v.length>0&&(b=v[0],Je(b),b!=null&&b.id&&(b!=null&&b.client_id)&&(le=b.id,re=b.client_id));const S=W(p.id);J(v,b),te(S)},!0,"client"),J(O),te(N)};ne()}function fo(){[we,Ce,Ee,de,ie,ue,Z,ve,ke,me].forEach(t=>{const n=document.getElementById(t);n instanceof HTMLInputElement?n.value="":n instanceof HTMLSelectElement&&(n.selectedIndex=0)}),le=null}document.addEventListener("DOMContentLoaded",()=>{var e;(e=document.querySelector('[data-action="openHome"]'))==null||e.addEventListener("click",t=>{t.preventDefault(),mo()})});function St(e,t){const n=document.createElement("div");n.textContent=t||"🔒 Заблоковано редагування",n.style.position="fixed",n.style.left="50%",n.style.bottom="50%",n.style.transform="translateX(-50%)",n.style.backgroundColor="#f44336",n.style.color="white",n.style.padding="12px 24px",n.style.borderRadius="8px",n.style.zIndex="10001",n.style.boxShadow="0 4px 12px rgba(0,0,0,0.2)",n.style.fontSize="16px",document.body.appendChild(n),setTimeout(()=>{n.remove()},1500)}const gt={1:{id:"toggle-shop",label:"Магазин _ Слюсар",class:"_shop"},2:{id:"toggle-receiver",label:"Приймальник",class:"_receiver"},3:{id:"toggle-income",label:"Джерело",class:"_income"}};function po(e){return`
    <label class="toggle-switch ${e.class}">
      <input type="checkbox" id="${e.id}" />
      <span class="slider"></span>
      <span class="label-text">${e.label}</span>
    </label>
  `}async function go(e){try{const{data:t,error:n}=await _.from("settings").select("setting_id, data");if(n){console.error("Помилка при завантаженні налаштувань:",n);return}t==null||t.forEach(o=>{const s=gt[o.setting_id];if(s){const a=e.querySelector(`#${s.id}`);a&&(a.checked=o.data)}})}catch(t){console.error("Помилка завантаження:",t)}}function yo(e){e.querySelectorAll('input[type="checkbox"]').forEach(n=>{const o=n.closest(".toggle-switch"),s=()=>{o==null||o.classList.toggle("active",n.checked)};s(),n.addEventListener("change",s)})}async function ho(e){if(!await Ot())return console.log("Збереження скасовано користувачем."),!1;const n=Object.entries(gt).map(([o,s])=>({setting_id:parseInt(o),data:e.querySelector(`#${s.id}`).checked}));try{for(const o of n){const{error:s}=await _.from("settings").upsert({setting_id:o.setting_id,data:o.data});s&&console.error(`Помилка збереження налаштування ${o.setting_id}:`,s)}return console.log("Налаштування успішно збережено!"),!0}catch(o){return console.error("Помилка при збереженні налаштувань:",o),!1}}async function vo(){if(document.getElementById("modal-settings"))return;const t=document.createElement("div");t.id="modal-settings",t.className="modal-settings hidden";const n=Object.values(gt).map(po).join("");if(t.innerHTML=`
    <div class="modal-window">
      <h2>Налаштування</h2>
      ${n}
      <div class="modal-actions">
        <button id="modal-cancel-button" type="button">Відмінити</button>
        <button id="modal-ok-button" type="button">ОК</button>
      </div>
    </div>
  `,!document.getElementById(Pe)){const a=Pt();document.body.appendChild(a)}document.body.appendChild(t),await go(t),yo(t),t.querySelector("#modal-ok-button").addEventListener("click",async()=>{await ho(t)&&t.classList.add("hidden")}),t.querySelector("#modal-cancel-button").addEventListener("click",()=>{t.classList.add("hidden")}),t.addEventListener("click",a=>{a.target===t&&t.classList.add("hidden")})}function bo(){const e=document.getElementById("modal-settings");e&&e.classList.remove("hidden")}document.addEventListener("DOMContentLoaded",()=>{const e=document.querySelector('[data-action="openSettings"]');e==null||e.addEventListener("click",async t=>{t.preventDefault();const{data:{session:n}}=await _.auth.getSession();if(!n){alert("⛔ Доступ заблоковано , Ви не авторизовані");return}document.getElementById("modal-settings")||await vo(),bo()})});class _o{constructor(){Oe(this,"searchIcon");Oe(this,"searchInput");Oe(this,"onSearchCallback");this.searchIcon=$("#searchIcon"),this.searchInput=$("#searchInput"),this.initSearch()}initSearch(){this.searchInput.css({width:"0",padding:"0",opacity:"0",visibility:"hidden"}),this.bindEvents()}bindEvents(){this.searchIcon.on("click",()=>{this.toggleSearchInput()}),this.searchInput.on("input",()=>{this.handleSearchInput()})}toggleSearchInput(){this.searchInput.width()===0?this.showSearchInput():this.hideSearchInput()}showSearchInput(){this.searchInput.css("visibility","visible"),this.searchInput.animate({width:"150px",padding:"3px 7px",opacity:"1"},300,()=>{this.searchInput.focus()})}hideSearchInput(){this.searchInput.animate({width:"0",padding:"0",opacity:"0"},300,()=>{this.searchInput.css("visibility","hidden"),this.searchInput.val(""),this.onSearchCallback&&this.onSearchCallback("")})}handleSearchInput(){var n;const t=((n=this.searchInput.val())==null?void 0:n.trim())||"";console.log("Термін пошуку:",t),this.onSearchCallback&&this.onSearchCallback(t)}setSearchCallback(t){this.onSearchCallback=t}setSearchValue(t){this.searchInput.val(t),this.onSearchCallback&&this.onSearchCallback(t)}getSearchValue(){var t;return((t=this.searchInput.val())==null?void 0:t.trim())||""}clearSearch(){this.searchInput.val(""),this.onSearchCallback&&this.onSearchCallback("")}isSearchOpen(){return this.searchInput.width()>0}}function Eo(e,t,n){const o=new _o;return o.setSearchCallback(s=>{const a=t(),{dateFrom:l,dateTo:r}=n();a==="open"?e(null,null,"open",s):e(l,r,"date_range",s)}),o}$(function(){let e="open",t=null,n=null;$("#dateRangePicker").daterangepicker({locale:{format:"DD.MM.YYYY",separator:" - ",applyLabel:"Прийняти",cancelLabel:"Відмінити",fromLabel:"Від",toLabel:"До",weekLabel:"Тиж",daysOfWeek:["Нд","Пн","Вт","Ср","Чт","Пт","Сб"],monthNames:["Січень","Лютий","Березень","Квітень","Травень","Червень","Липень","Серпень","Вересень","Жовтень","Листопад","Грудень"],firstDay:1},opens:"center",alwaysShowCalendars:!0,autoUpdateInput:!1,startDate:moment().startOf("year"),endDate:moment(),ranges:{Відкриті:[moment().startOf("year"),moment()],Сьогодні:[moment(),moment()],"Останні 7 днів":[moment().subtract(6,"days"),moment()],"Останні 30 днів":[moment().subtract(29,"days"),moment()],"Поточний місяць":[moment().startOf("month"),moment().endOf("month")],"Минулий місяць":[moment().subtract(1,"month").startOf("month"),moment().subtract(1,"month").endOf("month")],"Від початку":[moment("02.01.2025","DD.MM.YYYY"),moment()]},showCustomRangeLabel:!1},function(a,l,r){if(r==="Відкриті")$("#dateRangePicker").val("Відкриті"),$("#dateRangePicker").data("daterangepicker").element.removeClass("active-range"),e="open",t=null,n=null,K(null,null,"open"),this.setStartDate(moment().startOf("year")),this.setEndDate(moment());else{const i=`${a.format("DD.MM.YYYY")} - ${l.format("DD.MM.YYYY")}`;$("#dateRangePicker").val(i),$("#dateRangePicker").data("daterangepicker").element.addClass("active-range"),t=a.format("YYYY-MM-DD 00:00:00"),n=l.format("YYYY-MM-DD 23:59:59"),e="date_range",K(t,n)}}),$("#dateRangePicker").val("Відкриті"),e="open",K(null,null,"open");const o=$("#dateRangePicker").data("daterangepicker");o&&(o.setStartDate(moment().startOf("year")),o.setEndDate(moment()));const s=Eo(K,()=>e,()=>({dateFrom:t,dateTo:n}));window.searchHandler=s});export{Ht as g,K as l,Me as m};
